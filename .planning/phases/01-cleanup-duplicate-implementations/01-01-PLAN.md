---
phase: 01-cleanup-duplicate-implementations
plan: 01
type: execute
wave: 1
depends_on: []
files_modified:
  - frontend/src/lib/railgun-clean/index.js
  - frontend/src/lib/railgun-clean/connection.js
  - frontend/src/lib/railgun-clean/balances.js
  - frontend/src/lib/railgun-clean/payments.js
autonomous: true

must_haves:
  truths:
    - "All functions used by components are exported from railgun-clean/index.js"
    - "Legacy shim's working initialization code is preserved in railgun-clean"
    - "No stub functions throw 'not yet implemented' (either implement or remove)"
  artifacts:
    - path: "frontend/src/lib/railgun-clean/index.js"
      provides: "Complete public API exports"
      exports: ["connectRailgun", "disconnectRailgun", "restoreRailgunConnection", "getAllBalances", "refreshBalances", "privateTransfer", "setSignerAndProvider", "setRailgunIdentity", "getRailgunAddressFromCredentials", "shieldWETH", "getWETHBalance", "bootstrap"]
    - path: "frontend/src/lib/railgun-clean/connection.js"
      provides: "Wallet connection with engine initialization"
      min_lines: 100
    - path: "frontend/src/lib/railgun-clean/balances.js"
      provides: "Balance queries including refreshBalances"
      exports: ["getAllBalances", "refreshBalances"]
  key_links:
    - from: "frontend/src/lib/railgun-clean/index.js"
      to: "frontend/src/lib/railgun-clean/connection.js"
      via: "import/export"
      pattern: "from './connection'"
    - from: "frontend/src/lib/railgun-clean/connection.js"
      to: "@railgun-community/wallet"
      via: "SDK initialization"
      pattern: "import.*@railgun-community"
---

<objective>
Consolidate Railgun exports and extract working code from legacy files

Purpose: Components currently import functions that don't exist in railgun-clean, causing runtime errors. This plan audits what components need, extracts working implementations from legacy-shim, and consolidates everything into railgun-clean's public API.

Output: Complete railgun-clean/index.js with all required exports, no missing functions
</objective>

<execution_context>
@~/.claude/get-shit-done/workflows/execute-plan.md
@~/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/01-cleanup-duplicate-implementations/01-RESEARCH.md

# Key source files to analyze
@frontend/src/lib/railgun-clean/index.js
@frontend/src/lib/railgun-legacy-shim.js
@frontend/src/lib/railgun-client-browser.js
@frontend/src/lib/railgun-browser-init.js

# Components that import railgun functions
@frontend/src/components/railgun/PrivatePaymentModal.jsx
@frontend/src/components/railgun/PrivateFundsDrawer.jsx
@frontend/src/components/railgun/RailgunConnectionButton.jsx
@frontend/src/components/railgun/RailgunInitializationTest.jsx
</context>

<tasks>

<task type="auto">
  <name>Task 1: Audit component imports and map required functions</name>
  <files>
    frontend/src/components/railgun/PrivatePaymentModal.jsx
    frontend/src/components/railgun/PrivateFundsDrawer.jsx
    frontend/src/components/railgun/RailgunConnectionButton.jsx
    frontend/src/components/railgun/RailgunInitializationTest.jsx
    frontend/src/components/railgun/RailgunSimple.tsx
    frontend/src/components/marketplace/ProductFormStep2_5_Railgun.jsx
  </files>
  <action>
    Search all component files for imports from railgun-clean or legacy files.
    Create a definitive list of EVERY function components try to use:

    Expected findings (from research):
    - connectRailgun, disconnectRailgun, restoreRailgunConnection
    - setSignerAndProvider, setRailgunIdentity (deprecated but still imported)
    - refreshBalances, getAllBalances
    - privateTransfer (alias to paySellerV2)
    - getRailgunAddressFromCredentials
    - initRailgunForBrowser, stopRailgunEngineBrowser (from bootstrap)
    - shieldWETH, getWETHBalance, wrapETHtoWETH
    - checkWalletState

    For each function, document:
    1. Which component(s) use it
    2. Does it exist in railgun-clean/index.js currently?
    3. If missing, where is the implementation? (legacy-shim, browser-init, etc.)

    Output: Comment block at top of railgun-clean/index.js documenting the complete API
  </action>
  <verify>
    Run: grep -r "from.*railgun" frontend/src/components/ | grep -v node_modules
    All imports should reference railgun-clean only (no direct legacy imports)
  </verify>
  <done>Complete function audit documented, all required exports identified</done>
</task>

<task type="auto">
  <name>Task 2: Extract and consolidate missing functions into railgun-clean</name>
  <files>
    frontend/src/lib/railgun-clean/index.js
    frontend/src/lib/railgun-clean/connection.js
    frontend/src/lib/railgun-clean/balances.js
    frontend/src/lib/railgun-clean/payments.js
  </files>
  <action>
    For each missing function identified in Task 1:

    1. **setSignerAndProvider** - Add deprecated no-op stub with console.warn
       ```javascript
       export const setSignerAndProvider = () => {
         console.warn('setSignerAndProvider is deprecated - provider managed via window.ethereum');
       };
       ```

    2. **setRailgunIdentity** - Add deprecated no-op stub with console.warn
       ```javascript
       export const setRailgunIdentity = () => {
         console.warn('setRailgunIdentity is deprecated - identity managed internally');
       };
       ```

    3. **refreshBalances** - Extract from legacy-shim if useful, or alias to getAllBalances
       Add to balances.js and export from index.js

    4. **privateTransfer** - Alias paySellerV2 in index.js exports:
       ```javascript
       export { paySellerV2 as privateTransfer } from './payments';
       ```

    5. **getRailgunAddressFromCredentials** - Extract from legacy-shim or implement:
       Should fetch wallet info from backend and return railgunAddress
       Add to connection.js

    6. **initRailgunForBrowser, stopRailgunEngineBrowser** - Already in bootstrap.js, ensure exported

    7. **wrapETHtoWETH** - Currently throws "not implemented" in shield.js
       For Phase 1: Keep the throw but update message to be clearer:
       "wrapETHtoWETH will be implemented in Phase 3"
       (Actual implementation is Phase 3 scope)

    Update railgun-clean/index.js to export ALL required functions.
  </action>
  <verify>
    Run: node -e "const r = require('./frontend/src/lib/railgun-clean'); console.log(Object.keys(r))"
    Should list all required exports without errors
  </verify>
  <done>
    All functions components need are exported from railgun-clean/index.js
    - Deprecated functions have warning stubs
    - Missing functions extracted or implemented
    - Aliases created for renamed functions
  </done>
</task>

<task type="auto">
  <name>Task 3: Wire connection.js to use SDK directly (not legacy shim)</name>
  <files>
    frontend/src/lib/railgun-clean/connection.js
    frontend/src/lib/railgun-clean/bootstrap.js
  </files>
  <action>
    Examine current connection.js and ensure it:

    1. Uses bootstrap.js for engine initialization (not legacy-shim)
    2. Has proper initialization guard (hasEngine check, promise lock)
    3. Calls SDK functions directly via dynamic imports:
       ```javascript
       const { createRailgunWallet, loadRailgunWalletByID } = await import('@railgun-community/wallet');
       ```

    If connection.js currently imports from legacy-shim or browser-init:
    - Extract the essential logic
    - Rewrite to use SDK directly
    - Keep the same public API (connectRailgun, disconnectRailgun, restoreRailgunConnection)

    Critical patterns to preserve from legacy code:
    - Engine initialization with promise lock (prevent double-init)
    - Wallet caching (Map-based, keyed by userAddress)
    - Backend API calls for wallet credentials (fetchWalletCredentials pattern)
    - localStorage persistence of wallet ID

    Remove any imports from:
    - railgun-legacy-shim.js
    - railgun-browser-init.js (bootstrap.js should handle this)
  </action>
  <verify>
    Check connection.js has no imports from legacy files:
    grep -n "legacy-shim\|browser-init" frontend/src/lib/railgun-clean/connection.js
    Should return nothing
  </verify>
  <done>
    connection.js uses SDK directly via bootstrap.js
    No dependencies on legacy shim files
    All connection functions work with the same public API
  </done>
</task>

</tasks>

<verification>
1. All functions listed in RESEARCH.md "Missing Functions" section are now exported
2. No imports from legacy-shim.js or browser-init.js in railgun-clean/ files
3. Deprecated functions log warnings but don't break
4. Run: npm run build --prefix frontend (should complete without import errors)
</verification>

<success_criteria>
- railgun-clean/index.js exports 15+ functions covering all component needs
- Components can import any function they need from railgun-clean
- No runtime "X is not a function" errors from missing exports
- Legacy files are NOT imported by railgun-clean (clean dependency direction)
</success_criteria>

<output>
After completion, create `.planning/phases/01-cleanup-duplicate-implementations/01-01-SUMMARY.md`
</output>
