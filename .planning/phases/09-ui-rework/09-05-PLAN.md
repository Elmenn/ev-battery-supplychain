---
phase: 09-ui-rework
plan: 05
type: execute
wave: 2
depends_on: ["09-01", "09-04"]
files_modified:
  - frontend/src/components/shared/TransporterBidModal.jsx
  - frontend/src/components/shared/DeliveryConfirmModal.jsx
  - frontend/src/components/shared/PayoutSummaryCard.jsx
  - frontend/src/components/marketplace/ProductDetail.jsx
autonomous: true

must_haves:
  truths:
    - "Transporter can submit bid via modal with fee input, bond disclosure, and total ETH impact"
    - "Transporter can confirm delivery via modal with pre-filled hash and warning before submission"
    - "Transporter sees persistent payout summary card after delivery (bond returned + fee paid + total)"
    - "Transporter can withdraw bid if not selected (OrderConfirmed or Expired phase)"
    - "TransporterBidModal sends bondAmount as msg.value (not fee amount)"
  artifacts:
    - path: "frontend/src/components/shared/TransporterBidModal.jsx"
      provides: "Bid submission modal"
      min_lines: 60
    - path: "frontend/src/components/shared/DeliveryConfirmModal.jsx"
      provides: "Delivery confirmation modal with hash pre-fill"
      min_lines: 50
    - path: "frontend/src/components/shared/PayoutSummaryCard.jsx"
      provides: "Post-delivery payout breakdown card"
      min_lines: 30
  key_links:
    - from: "frontend/src/components/shared/TransporterBidModal.jsx"
      to: "frontend/src/utils/escrowHelpers.js"
      via: "getEscrowContract for createTransporter call"
      pattern: "createTransporter"
    - from: "frontend/src/components/shared/DeliveryConfirmModal.jsx"
      to: "frontend/src/utils/escrowHelpers.js"
      via: "getEscrowContract for confirmDelivery call"
      pattern: "confirmDelivery"
    - from: "frontend/src/components/marketplace/ProductDetail.jsx"
      to: "frontend/src/components/shared/TransporterBidModal.jsx"
      via: "import and render"
      pattern: "import.*TransporterBidModal"
---

<objective>
Create transporter flow components (bid modal, delivery confirmation modal, payout summary card) and wire them into ProductDetail.jsx.

Purpose: Transporters are the third party in the escrow flow. They need to bid on deliveries, confirm delivery via hash verification, and see their payout breakdown. This completes the three-party UI.

Output: 3 new shared components + transporter panel integrated into ProductDetail
</objective>

<execution_context>
@~/.claude/get-shit-done/workflows/execute-plan.md
@~/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/09-ui-rework/09-RESEARCH.md
@.planning/phases/09-ui-rework/09-01-SUMMARY.md
@.planning/phases/09-ui-rework/09-04-SUMMARY.md

@frontend/src/utils/escrowHelpers.js
@frontend/src/components/marketplace/ProductDetail.jsx
@frontend/src/utils/errorHandler.js
@contracts/ProductEscrow_Initializer.sol
</context>

<tasks>

<task type="auto">
  <name>Task 1: Create TransporterBidModal, DeliveryConfirmModal, and PayoutSummaryCard</name>
  <files>
    frontend/src/components/shared/TransporterBidModal.jsx
    frontend/src/components/shared/DeliveryConfirmModal.jsx
    frontend/src/components/shared/PayoutSummaryCard.jsx
  </files>
  <action>
**TransporterBidModal.jsx:**
Props: `{ isOpen, onClose, onSuccess, productAddress, provider, bondAmountWei }`

Layout (use existing modal pattern -- fixed overlay):
1. Title: "Submit Delivery Bid"
2. Fee input: labeled "Your delivery fee (ETH)", type="number", step="0.001", min="0"
3. Read-only bond disclosure card:
   - "Bond required: {ethers.formatEther(bondAmountWei)} ETH"
   - "Your bond is refundable unless slashed by timeout conditions"
4. Total ETH impact summary:
   - "Fee quoted: {feeInput} ETH"
   - "Bond staked: {formatEther(bondAmountWei)} ETH"
   - "Total ETH locked: {total} ETH"
5. Submit button: "Submit Bid & Stake Bond"

Handler `handleSubmitBid`:
```javascript
const signer = await provider.getSigner();
const contract = getEscrowContract(productAddress, signer);
const feeWei = ethers.parseEther(feeInput);
// CRITICAL: msg.value is bondAmount, NOT fee. Fee is the function parameter.
const tx = await contract.createTransporter(feeWei, { value: bondAmountWei });
await tx.wait();
toast.success("Bid submitted!");
onSuccess();
```

Disable button when feeInput is empty/zero or during loading.
Wrap in try/catch with decodeContractError for user-friendly errors.

**DeliveryConfirmModal.jsx:**
Props: `{ isOpen, onClose, onSuccess, productAddress, provider, vcHash }`

Layout:
1. Title: "Confirm Delivery"
2. Hash display: pre-filled from `vcHash` prop in a read-only input (font-mono)
3. Editable fallback: a checkbox "Enter hash manually" that enables editing the input field (for off-app hash reception). Default: pre-filled and read-only.
4. Warning box (bg-amber-50 border-amber-200):
   - "By confirming delivery, you verify that the product has been delivered to the buyer. Your bond and delivery fee will be released."
5. Two buttons: "Cancel" + "Confirm Delivery"

Handler `handleConfirmDelivery`:
```javascript
const signer = await provider.getSigner();
const contract = getEscrowContract(productAddress, signer);
const hashToSubmit = manualEntry ? manualHash : vcHash;
const tx = await contract.confirmDelivery(hashToSubmit);
await tx.wait();
toast.success("Delivery confirmed! Funds released.");
onSuccess();
```

Use decodeContractError in catch block.

**PayoutSummaryCard.jsx:**
Props: `{ bondReturned, feePaid, txHash }`

All amounts in wei (BigInt). Display:
- Title: "Delivery Payout Summary" with green checkmark icon (lucide-react CheckCircle)
- Line items:
  - "Bond returned: {formatEther(bondReturned)} ETH"
  - "Delivery fee: {formatEther(feePaid)} ETH"
  - "Total received: {formatEther(bondReturned + feePaid)} ETH"
- Transaction link: if txHash, show "View transaction" link using getExplorerUrl
- Card styling: bg-green-50 border-green-200 rounded-lg p-4

All components use Tailwind CSS. Import getEscrowContract from escrowHelpers, ethers, toast, decodeContractError as needed.
  </action>
  <verify>
    - All 3 files exist in `frontend/src/components/shared/`
    - TransporterBidModal has `createTransporter` call with `{ value: bondAmountWei }` (NOT feeWei)
    - DeliveryConfirmModal has `confirmDelivery(hashToSubmit)` call
    - PayoutSummaryCard renders bond + fee + total line items
    - Build succeeds
  </verify>
  <done>Three transporter components created: bid modal (fee input + bond stake), delivery confirm modal (pre-filled hash + manual fallback + warning), payout summary card (persistent financial breakdown).</done>
</task>

<task type="auto">
  <name>Task 2: Wire transporter actions into ProductDetail.jsx</name>
  <files>frontend/src/components/marketplace/ProductDetail.jsx</files>
  <action>
Add transporter panel and modals to ProductDetail.jsx:

**New imports:**
```javascript
import TransporterBidModal from "../shared/TransporterBidModal";
import DeliveryConfirmModal from "../shared/DeliveryConfirmModal";
import PayoutSummaryCard from "../shared/PayoutSummaryCard";
```

**New state:**
```javascript
const [showBidModal, setShowBidModal] = useState(false);
const [showDeliveryModal, setShowDeliveryModal] = useState(false);
```

**Render additions (add to the role-aware action panel section):**

Replace the `{/* Transporter actions -- see Plan 05 */}` comment with:

1. **Transporter: Submit Bid (phase=OrderConfirmed, role=visitor -- any non-seller/buyer can bid):**
```jsx
{product.phase === Phase.OrderConfirmed && role.role === "visitor" && (
  <Button onClick={() => setShowBidModal(true)} className="bg-cyan-600 hover:bg-cyan-700">
    Submit Delivery Bid
  </Button>
)}
```

2. **Transporter: Confirm Delivery (phase=Bound, role=transporter):**
```jsx
{role.role === "transporter" && product.phase === Phase.Bound && (
  <div className="bg-emerald-50 border border-emerald-200 rounded-lg p-4">
    <h3 className="font-semibold text-emerald-800 mb-2">Ready to Confirm Delivery</h3>
    <p className="text-sm text-emerald-700 mb-3">Verify the delivery hash and confirm on-chain to release funds.</p>
    <Button onClick={() => setShowDeliveryModal(true)} className="bg-emerald-600 hover:bg-emerald-700">
      Confirm Delivery
    </Button>
  </div>
)}
```

3. **Transporter: Withdraw Bid (phase=OrderConfirmed or Expired, not selected):**
```jsx
{role.role === "visitor" && (product.phase === Phase.OrderConfirmed || product.phase === Phase.Expired) &&
  bids.some(b => b.address.toLowerCase() === currentUser?.toLowerCase()) && (
  <Button variant="outline" onClick={handleWithdrawBid} disabled={actionLoading}>
    Withdraw Bid
  </Button>
)}
```

Add `handleWithdrawBid`:
```javascript
const handleWithdrawBid = async () => {
  setActionLoading(true);
  try {
    const signer = await provider.getSigner();
    const contract = getEscrowContract(address, signer);
    const tx = await contract.withdrawBid();
    await tx.wait();
    toast.success("Bid withdrawn, bond returned!");
    await loadProductData();
  } catch (err) {
    toast.error("Withdraw failed: " + (decodeContractError(err) || err.message));
  } finally {
    setActionLoading(false);
  }
};
```

4. **Post-delivery payout (phase=Delivered, role=transporter):**
```jsx
{role.role === "transporter" && product.phase === Phase.Delivered && (
  <PayoutSummaryCard
    bondReturned={product.bondAmount}
    feePaid={product.deliveryFee}
    txHash={null}
  />
)}
```

5. **Render modals (at bottom of component, inside the return):**
```jsx
{showBidModal && (
  <TransporterBidModal
    isOpen={showBidModal}
    onClose={() => setShowBidModal(false)}
    onSuccess={() => { setShowBidModal(false); loadProductData(); }}
    productAddress={address}
    provider={provider}
    bondAmountWei={product.bondAmount}
  />
)}

{showDeliveryModal && (
  <DeliveryConfirmModal
    isOpen={showDeliveryModal}
    onClose={() => setShowDeliveryModal(false)}
    onSuccess={() => { setShowDeliveryModal(false); loadProductData(); }}
    productAddress={address}
    provider={provider}
    vcHash={product.vcHash}
  />
)}
```
  </action>
  <verify>
    - `grep "TransporterBidModal\|DeliveryConfirmModal\|PayoutSummaryCard" frontend/src/components/marketplace/ProductDetail.jsx` shows all 3 imported and rendered
    - `grep "withdrawBid" frontend/src/components/marketplace/ProductDetail.jsx` shows handler exists
    - `grep "showBidModal\|showDeliveryModal" frontend/src/components/marketplace/ProductDetail.jsx` shows state variables
    - Build succeeds
  </verify>
  <done>ProductDetail.jsx has full transporter flow: bid submission button (visitors in OrderConfirmed phase), delivery confirmation button (assigned transporter in Bound phase), bid withdrawal (non-selected transporters), and persistent payout summary (transporter in Delivered phase).</done>
</task>

</tasks>

<verification>
- TransporterBidModal correctly sends bondAmount as msg.value (not fee)
- DeliveryConfirmModal pre-fills hash and has manual fallback
- PayoutSummaryCard shows bond + fee + total breakdown
- Transporter can bid when phase=OrderConfirmed
- Transporter can confirm delivery when phase=Bound
- Transporter can withdraw bid when not selected
- Transporter sees payout after delivery
- Frontend builds without errors
</verification>

<success_criteria>
- Transporter submits bid: sees fee input, bond disclosure, total ETH impact, then stakes bond
- Delivery confirmation: hash pre-filled from contract, warning shown, one-click confirm
- Payout card persists after delivery (not just a toast)
- Withdraw bid available for non-selected transporters in OrderConfirmed or Expired phase
</success_criteria>

<output>
After completion, create `.planning/phases/09-ui-rework/09-05-SUMMARY.md`
</output>
