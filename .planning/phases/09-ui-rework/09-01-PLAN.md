---
phase: 09-ui-rework
plan: 01
type: execute
wave: 1
depends_on: []
files_modified:
  - frontend/src/utils/escrowHelpers.js
  - frontend/src/components/shared/PhaseTimeline.jsx
  - frontend/src/components/shared/HashDisplay.jsx
  - frontend/src/components/shared/CountdownTimer.jsx
  - frontend/src/components/shared/BondCard.jsx
autonomous: true

must_haves:
  truths:
    - "escrowHelpers exports Phase enum, PHASE_LABELS, time windows, getEscrowContract, getProductState, detectRole"
    - "PhaseTimeline renders horizontal stepper on wide screens and vertical badge list on narrow screens"
    - "HashDisplay shows truncated hash with copy button, QR code via qrcode.react, and guidance text"
    - "CountdownTimer shows live h/m/s countdown, turns yellow at 25% remaining and red at 10%"
    - "BondCard shows read-only bond amount in ETH with explanation text"
  artifacts:
    - path: "frontend/src/utils/escrowHelpers.js"
      provides: "Contract interaction layer and role detection"
      exports: ["Phase", "PHASE_LABELS", "SELLER_WINDOW", "BID_WINDOW", "DELIVERY_WINDOW", "getEscrowContract", "getProductState", "detectRole"]
    - path: "frontend/src/components/shared/PhaseTimeline.jsx"
      provides: "Adaptive phase timeline component"
      min_lines: 50
    - path: "frontend/src/components/shared/HashDisplay.jsx"
      provides: "Hash display with copy + QR"
      min_lines: 30
    - path: "frontend/src/components/shared/CountdownTimer.jsx"
      provides: "Live countdown timer with color thresholds"
      min_lines: 30
    - path: "frontend/src/components/shared/BondCard.jsx"
      provides: "Bond amount display card"
      min_lines: 15
  key_links:
    - from: "frontend/src/utils/escrowHelpers.js"
      to: "frontend/src/abis/ProductEscrow_Initializer.json"
      via: "ABI import"
      pattern: "import.*ProductEscrow_Initializer"
    - from: "frontend/src/components/shared/HashDisplay.jsx"
      to: "qrcode.react"
      via: "QRCodeSVG import"
      pattern: "import.*qrcode\\.react"
---

<objective>
Create the contract interaction helper module and shared UI building blocks that all subsequent Phase 9 plans depend on.

Purpose: Centralizes all escrow contract reads/writes in one module (eliminating scattered `new ethers.Contract(...)` calls) and provides reusable components (timeline, hash display, countdown, bond card) that ProductDetail, ProductCard, and modal components will compose.

Output: `escrowHelpers.js` utility + 4 shared React components + qrcode.react installed
</objective>

<execution_context>
@~/.claude/get-shit-done/workflows/execute-plan.md
@~/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/09-ui-rework/09-RESEARCH.md

@frontend/src/abis/ProductEscrow_Initializer.json
@frontend/src/utils/web3Utils.js
@frontend/src/components/ui/button.js
@contracts/ProductEscrow_Initializer.sol
</context>

<tasks>

<task type="auto">
  <name>Task 1: Install qrcode.react and create escrowHelpers.js</name>
  <files>
    frontend/src/utils/escrowHelpers.js
  </files>
  <action>
1. Install qrcode.react:
   ```bash
   cd frontend && npm install qrcode.react
   ```

2. Create `frontend/src/utils/escrowHelpers.js` with:

   - `Phase` enum object mapping phase names to numbers:
     ```
     Listed: 0, Purchased: 1, OrderConfirmed: 2, Bound: 3, Delivered: 4, Expired: 5
     ```
   - `PHASE_LABELS` mapping Phase values to display strings:
     ```
     0: "Listed", 1: "Purchased", 2: "Order Confirmed", 3: "In Delivery", 4: "Delivered", 5: "Expired"
     ```
   - Time window constants matching contract:
     ```
     SELLER_WINDOW = 2 * 24 * 60 * 60  (2 days in seconds)
     BID_WINDOW = 2 * 24 * 60 * 60
     DELIVERY_WINDOW = 2 * 24 * 60 * 60
     ```
   - `getEscrowContract(address, signerOrProvider)` -- returns `new ethers.Contract(address, ABI, signerOrProvider)`
   - `getProductState(address, provider)` -- reads ALL contract state in parallel via Promise.all:
     name, owner, buyer, purchased, delivered, transporter, phase, getVcHash, priceCommitment,
     sellerBond, bondAmount, deliveryFee, purchaseTimestamp, orderConfirmedTimestamp, boundTimestamp, id.
     Returns object with all fields, phase as Number, timestamps as Number, address included.
   - `detectRole(product, currentUser)` -- returns `{ role: "seller"|"buyer"|"transporter"|"visitor" }`.
     Compare lowercased addresses. Check owner first, then buyer (must not be ZeroAddress), then transporter (must not be ZeroAddress). Default to "visitor".

   Import ABI from `../../abis/ProductEscrow_Initializer.json` (use `.abi` property). Import ethers from "ethers".

   IMPORTANT: Use ethers v6 API (ethers.Contract, ethers.ZeroAddress, etc.). Do NOT use ethers v5 patterns.
  </action>
  <verify>
    - File exists at `frontend/src/utils/escrowHelpers.js`
    - Exports: Phase, PHASE_LABELS, SELLER_WINDOW, BID_WINDOW, DELIVERY_WINDOW, getEscrowContract, getProductState, detectRole
    - `cd frontend && npx react-scripts build 2>&1 | head -20` compiles without errors (or at least escrowHelpers itself has no syntax errors)
  </verify>
  <done>escrowHelpers.js exports all contract interaction functions and constants. No scattered contract instantiation needed in components.</done>
</task>

<task type="auto">
  <name>Task 2: Create shared UI components (PhaseTimeline, HashDisplay, CountdownTimer, BondCard)</name>
  <files>
    frontend/src/components/shared/PhaseTimeline.jsx
    frontend/src/components/shared/HashDisplay.jsx
    frontend/src/components/shared/CountdownTimer.jsx
    frontend/src/components/shared/BondCard.jsx
  </files>
  <action>
Create directory `frontend/src/components/shared/` and add four components:

**PhaseTimeline.jsx:**
- Props: `{ currentPhase, phases }` where phases is optional (defaults to the standard 6 phases from Phase enum)
- Desktop (md+ breakpoint): horizontal stepper with circles connected by lines. Current phase highlighted in blue, completed phases in green, future phases in gray. Expired/Slashed shown in red.
- Mobile (below md): vertical list with badge + label for each phase. Current phase has a filled circle, completed have checkmarks.
- Use Tailwind responsive classes (`hidden md:flex` / `md:hidden`) for breakpoint switching.
- Each step shows the phase label from PHASE_LABELS.
- Import Phase, PHASE_LABELS from `../../utils/escrowHelpers`.

**HashDisplay.jsx:**
- Props: `{ hash, label, guidance }` -- all strings
- Renders a gray-50 card with:
  - Label as h4
  - Hash in monospace `<code>` with truncation (show first 10 + last 8 chars)
  - "Copy" button that copies full hash to clipboard, shows "Copied!" for 2 seconds
  - QR code via `<QRCodeSVG value={hash} size={128} />` from qrcode.react, centered
  - Optional guidance text in xs gray below
- If hash is falsy or all zeros (bytes32 zero), show "Not yet available" instead of the hash/QR.

**CountdownTimer.jsx:**
- Props: `{ deadline, windowSeconds, label }` -- deadline is unix timestamp (seconds), windowSeconds is total window duration (for percentage calc), label is display string
- Uses `useState` + `useEffect` with `setInterval(update, 1000)` and cleanup on unmount.
- Computes remaining = max(0, deadline - now). Percentage = remaining / windowSeconds.
- Display: `{label}: {hours}h {minutes}m {seconds}s` in monospace.
- Color: green-600 when pct > 25%, yellow-600 when pct <= 25%, red-600 when pct <= 10%.
- When remaining <= 0: show "Expired" in red-600 font-medium.
- Also show absolute deadline as date/time string below the countdown in text-xs text-gray-500.

**BondCard.jsx:**
- Props: `{ bondAmountWei, label, explanation }` -- bondAmountWei is BigInt or string, label defaults to "Protocol Collateral", explanation defaults to "Refundable bond held in escrow until successful delivery"
- Renders a small card (border rounded p-3 bg-amber-50 border-amber-200) with:
  - Shield icon (use lucide-react Shield) + label
  - Bond amount formatted via `ethers.formatEther(bondAmountWei)` + " ETH"
  - Explanation text in text-xs text-gray-600

All components use Tailwind CSS classes exclusively. No inline styles. Import lucide-react icons where needed (Shield for BondCard).
  </action>
  <verify>
    - All 4 files exist in `frontend/src/components/shared/`
    - Each file has a default export
    - `cd frontend && npx react-scripts build 2>&1 | head -20` -- no import/syntax errors
  </verify>
  <done>Four shared components created: PhaseTimeline (adaptive horizontal/vertical), HashDisplay (copy + QR), CountdownTimer (live with color thresholds), BondCard (read-only bond display). All use Tailwind CSS and are ready for composition in ProductDetail and modals.</done>
</task>

</tasks>

<verification>
- `npm install` in frontend succeeds (qrcode.react added to package.json)
- All 5 new files exist and export correctly
- `npx react-scripts build` in frontend directory does not error on these new files
- escrowHelpers.js Phase enum matches contract Phase enum (0-5)
</verification>

<success_criteria>
- escrowHelpers.js provides centralized contract access (no more scattered ethers.Contract calls needed)
- detectRole correctly identifies seller/buyer/transporter/visitor
- All 4 shared components render without errors
- HashDisplay uses qrcode.react for QR generation
- CountdownTimer properly cleans up interval on unmount
</success_criteria>

<output>
After completion, create `.planning/phases/09-ui-rework/09-01-SUMMARY.md`
</output>
