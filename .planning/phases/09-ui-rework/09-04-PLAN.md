---
phase: 09-ui-rework
plan: 04
type: execute
wave: 2
depends_on: ["09-01"]
files_modified:
  - frontend/src/components/marketplace/ProductDetail.jsx
autonomous: true

must_haves:
  truths:
    - "ProductDetail uses getProductState and detectRole from escrowHelpers (not scattered contract calls)"
    - "Seller sees sticky CTA to confirm order when phase is Purchased"
    - "Seller confirm order flow: sign VC -> upload IPFS -> confirmOrder on-chain (1-click with step-by-step fallback)"
    - "Seller confirm order uses product.memoHash and product.railgunTxRef from getProductState (not placeholder zeros)"
    - "Seller sees sortable transporter bid table when phase is OrderConfirmed"
    - "Seller can select transporter via styled confirmation modal (not window.confirm) showing fee deposit details"
    - "Buyer sees 'Buy with Railgun' button when phase is Listed"
    - "Buyer sees payment recorded card with truncated memoHash/txRef and copy buttons after purchase"
    - "Hash display visible for seller/buyer/transporter when phase >= OrderConfirmed"
    - "PhaseTimeline shown at top of ProductDetail"
    - "All dead code from old flow removed (buildStage2VC, buildStage3VC, confirmOrderWithCommitment, revealAndConfirmDelivery, IS_RAILGUN_API_CONFIGURED paths)"
  artifacts:
    - path: "frontend/src/components/marketplace/ProductDetail.jsx"
      provides: "Role-aware product detail page with new contract flow"
      min_lines: 400
  key_links:
    - from: "frontend/src/components/marketplace/ProductDetail.jsx"
      to: "frontend/src/utils/escrowHelpers.js"
      via: "getProductState, detectRole imports"
      pattern: "import.*escrowHelpers"
    - from: "frontend/src/components/marketplace/ProductDetail.jsx"
      to: "frontend/src/utils/vcBuilder.mjs"
      via: "appendPaymentProof import (for seller confirm)"
      pattern: "import.*appendPaymentProof.*vcBuilder"
    - from: "frontend/src/components/marketplace/ProductDetail.jsx"
      to: "frontend/src/components/shared/PhaseTimeline.jsx"
      via: "PhaseTimeline component"
      pattern: "import.*PhaseTimeline"
---

<objective>
Rewrite ProductDetail.jsx to use the new contract interface, remove all dead code from the old flow, and implement role-aware action panels for seller and buyer.

Purpose: ProductDetail is the central hub (~2100 lines) with massive amounts of dead code referencing deprecated functions. This plan guts the old logic and replaces it with the new Phase 7/8 flow: seller confirms order (VC sign + IPFS + on-chain), seller selects transporter from bid table, buyer initiates private payment, and both see hash display post-confirmation.

Output: Rewritten ProductDetail.jsx (~600-800 lines, down from 2100) with seller/buyer panels and shared timeline
</objective>

<execution_context>
@~/.claude/get-shit-done/workflows/execute-plan.md
@~/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/09-ui-rework/09-RESEARCH.md
@.planning/phases/09-ui-rework/09-01-SUMMARY.md

@frontend/src/components/marketplace/ProductDetail.jsx
@frontend/src/utils/escrowHelpers.js
@frontend/src/utils/vcBuilder.mjs
@frontend/src/utils/signVcWithMetamask.js
@frontend/src/utils/ipfs.js
@frontend/src/utils/errorHandler.js
@frontend/src/components/shared/PhaseTimeline.jsx
@frontend/src/components/shared/HashDisplay.jsx
@frontend/src/components/shared/CountdownTimer.jsx
@frontend/src/components/shared/BondCard.jsx
</context>

<tasks>

<task type="auto">
  <name>Task 1: Rewrite ProductDetail.jsx -- state, data loading, and dead code removal</name>
  <files>frontend/src/components/marketplace/ProductDetail.jsx</files>
  <action>
This is a MAJOR rewrite. The current file is ~2100 lines with massive dead code. Rewrite from scratch, keeping only the patterns and imports that are still valid.

**STRUCTURE:**
The new ProductDetail should be organized as:
1. Imports
2. Constants
3. Component function with: state -> data loading -> handlers -> render

**IMPORTS (keep/add):**
```javascript
import React, { useEffect, useState, useCallback } from "react";
import { useParams } from "react-router-dom";
import { ethers } from "ethers";
import toast from "react-hot-toast";
import { getProductState, detectRole, Phase, PHASE_LABELS, getEscrowContract, SELLER_WINDOW, BID_WINDOW, DELIVERY_WINDOW } from "../../utils/escrowHelpers";
import { fetchJson, uploadJson } from "../../utils/ipfs";
import { appendPaymentProof } from "../../utils/vcBuilder.mjs";
import { signVcAsSeller } from "../../utils/signVcWithMetamask";
import { decodeContractError, getExplorerUrl } from "../../utils/errorHandler";
import ProductEscrowABI from "../../abis/ProductEscrow_Initializer.json";
import PrivatePaymentModal from "../railgun/PrivatePaymentModal";
import { PhaseTimeline } from "../shared/PhaseTimeline";
import { HashDisplay } from "../shared/HashDisplay";
import { CountdownTimer } from "../shared/CountdownTimer";
import { BondCard } from "../shared/BondCard";
import { Button } from "../ui/button";
```

**REMOVE these imports entirely:**
- `buildStage2VC`, `buildStage3VC`, `freezeVcJson` from vcBuilder.mjs
- `signVcWithMetamask` (keep only `signVcAsSeller`)
- `generateCommitmentWithBindingTag`, `verifyCommitmentMatch`, `generateDeterministicBlinding`, `generateTxHashCommitmentBindingTag` from commitmentUtils
- `VCViewer`, `VerifyVCInline`, `ProvenanceChainViewer` (old VC display components)
- `Tabs`, `Tab` from ui/Tabs
- `Eye`, `EyeOff` from lucide-react (not needed in new design)
- `confirmOrder` from web3Utils (handle inline with escrowHelpers)
- `getCurrentCid` from web3Utils (use getProductState which reads vcHash)

**STATE (simplified):**
```javascript
const [product, setProduct] = useState(null);
const [loading, setLoading] = useState(true);
const [error, setError] = useState("");
const [role, setRole] = useState({ role: "visitor" });
const [bids, setBids] = useState([]); // [{address, fee}]
const [showPrivatePaymentModal, setShowPrivatePaymentModal] = useState(false);
const [actionLoading, setActionLoading] = useState(false); // for any action button
const [showTransporterConfirm, setShowTransporterConfirm] = useState(null); // {address, fee} or null
```

Remove ALL of these dead state variables:
- vcStages, expandedVCIndex, vcDraft, vcDraftSaved, vcSellerSigned
- provenanceVC, provenanceLoading
- pendingPrivatePayments, confirmingPayment, deletingReceipt, privatePaymentHistory
- buyerEOA, sellerEOA, buyerRailgun, sellerRailgun
- lastKnownBuyer, lastKnownBuyerEOA, identityLocked
- isCheckingPending, isLoadingProduct, isPopulatingAddresses refs
- statusMessage (use toast instead)

**DATA LOADING:**
Single `loadProductData` function using `getProductState`:
```javascript
const loadProductData = useCallback(async () => {
  try {
    setLoading(true);
    const state = await getProductState(address, provider);
    setProduct(state);
    setRole(detectRole(state, currentUser));

    // Load bids if phase is OrderConfirmed
    if (state.phase === Phase.OrderConfirmed) {
      const contract = getEscrowContract(address, provider);
      const [addrs, fees] = await contract.getAllTransporters();
      setBids(addrs.map((a, i) => ({ address: a, fee: fees[i] })));
    }
  } catch (err) {
    setError("Failed to load product: " + err.message);
  } finally {
    setLoading(false);
  }
}, [address, provider, currentUser]);
```

Call loadProductData on mount and when address/provider/currentUser changes.

**DELETE these entire functions/callbacks:**
- `deletePendingReceipt` (backend API, deprecated)
- `checkPendingPrivatePayments` (backend API, deprecated)
- `loadPrivatePaymentHistory` (backend API, deprecated)
- `markPrivatePaymentConfirmed` (backend API, deprecated)
- `confirmPrivatePayment` (old seller confirmation, replaced by buyer calling recordPrivatePayment directly)
- `handleConfirmOrder` (the old 600-790 line version that calls buildStage2VC)
- `handleRequestSellerSignature` (old buyer-driven delivery, removed)
- `handleSignAsSeller` (old buyer-driven delivery, removed)
- `handleConfirmDeliveryClick` (old buyer-driven delivery, removed)
- All Railgun API resolution effects (resolveRailgun, IS_RAILGUN_API_CONFIGURED paths)
- The pending payment polling effect
- The address population effect (isPopulatingAddresses)

**REMOVE these constants:**
- `IS_RAILGUN_API_CONFIGURED` (always false, dead code)
- `RAILGUN_API_BASE` (backend API, deprecated)
- `getPrivatePaymentHistoryKey`, `getPendingPrivatePaymentKey`
  </action>
  <verify>
    - `grep -c "buildStage2VC\|buildStage3VC\|freezeVcJson" frontend/src/components/marketplace/ProductDetail.jsx` returns 0
    - `grep -c "IS_RAILGUN_API_CONFIGURED" frontend/src/components/marketplace/ProductDetail.jsx` returns 0
    - `grep -c "revealAndConfirmDelivery\|updateVcCidAfterDelivery\|confirmOrderWithCommitment" frontend/src/components/marketplace/ProductDetail.jsx` returns 0
    - `grep "getProductState\|detectRole" frontend/src/components/marketplace/ProductDetail.jsx` returns matches
    - File is under 900 lines
  </verify>
  <done>ProductDetail.jsx gutted of all dead code, uses getProductState/detectRole from escrowHelpers, has clean state management with showTransporterConfirm state for styled modal.</done>
</task>

<task type="auto">
  <name>Task 2: Implement seller/buyer action panels and render section</name>
  <files>frontend/src/components/marketplace/ProductDetail.jsx</files>
  <action>
Continue building ProductDetail.jsx with the action handlers and render section:

**SELLER HANDLERS:**

1. `handleConfirmOrder` (new version -- 1-click flow):
```javascript
const handleConfirmOrder = async () => {
  setActionLoading(true);
  try {
    const signer = await provider.getSigner();

    // 1. Fetch listing VC from IPFS
    const listingCid = localStorage.getItem(`vcCid_${address}`);
    if (!listingCid) throw new Error("No listing VC found. Was the product created from this browser?");
    const listingVc = await fetchJson(listingCid);

    // 2. Append payment proof using REAL on-chain values from getProductState
    // CRITICAL: Use product.memoHash and product.railgunTxRef from contract state,
    // NOT placeholder zeros. These were recorded by the buyer's recordPrivatePayment call.
    const updatedVc = appendPaymentProof(listingVc, {
      buyerAddr: product.buyer,
      memoHash: product.memoHash,       // from productMemoHashes(id) via getProductState
      railgunTxRef: product.railgunTxRef, // from productRailgunTxRefs(id) via getProductState
      previousVersionCid: listingCid,
    });

    // 3. Sign
    const proof = await signVcAsSeller(updatedVc, signer, address);
    updatedVc.proof.push(proof);

    // 4. Upload to IPFS
    toast("Uploading VC to IPFS...");
    const newCid = await uploadJson(updatedVc);
    localStorage.setItem(`vcCid_${address}`, newCid);

    // 5. Confirm on-chain
    toast("Confirming order on-chain...");
    const contract = getEscrowContract(address, signer);
    const tx = await contract.confirmOrder(newCid);
    const receipt = await tx.wait();

    toast.success("Order confirmed! " + getExplorerUrl(receipt.hash));
    await loadProductData(); // refresh
  } catch (err) {
    const msg = decodeContractError(err) || err.message;
    toast.error("Confirm failed: " + msg);
  } finally {
    setActionLoading(false);
  }
};
```

2. `handleSelectTransporter(bidAddress)` -- uses styled modal instead of window.confirm:
```javascript
// When user clicks "Select" on a bid row, open confirmation modal:
const openTransporterConfirm = (bid) => {
  setShowTransporterConfirm(bid); // { address, fee }
};

const handleSelectTransporter = async () => {
  const bid = showTransporterConfirm;
  if (!bid) return;
  setShowTransporterConfirm(null);
  setActionLoading(true);
  try {
    const signer = await provider.getSigner();
    const contract = getEscrowContract(address, signer);

    const tx = await contract.setTransporter(bid.address, { value: bid.fee });
    await tx.wait();
    toast.success("Transporter selected!");
    await loadProductData();
  } catch (err) {
    toast.error("Failed: " + (decodeContractError(err) || err.message));
  } finally {
    setActionLoading(false);
  }
};
```

**RENDER STRUCTURE:**
```jsx
return (
  <div className="max-w-4xl mx-auto px-4 py-8 space-y-6">
    {/* Phase Timeline */}
    <PhaseTimeline currentPhase={product.phase} />

    {/* Header: name, owner, buyer, phase badge */}
    <div className="flex flex-wrap items-end justify-between gap-4">
      <div>
        <h2 className="text-2xl font-bold">{product.name}</h2>
        <p className="text-sm text-gray-600">Owner: {product.owner.slice(0,6)}...{product.owner.slice(-4)}</p>
        {product.buyer !== ethers.ZeroAddress && (
          <p className="text-sm text-gray-600">Buyer: {product.buyer.slice(0,6)}...{product.buyer.slice(-4)}</p>
        )}
      </div>
      <span className={`rounded-md px-3 py-1 text-sm font-medium ${phaseColor}`}>
        {PHASE_LABELS[product.phase]}
      </span>
    </div>

    {/* Bond info */}
    {product.sellerBond > 0n && (
      <BondCard bondAmountWei={product.sellerBond} />
    )}

    {/* Countdown timers (role + phase aware) */}
    {product.phase === Phase.Purchased && product.purchaseTimestamp > 0 && (
      <CountdownTimer
        deadline={product.purchaseTimestamp + SELLER_WINDOW}
        windowSeconds={SELLER_WINDOW}
        label="Seller must confirm by"
      />
    )}
    {product.phase === Phase.OrderConfirmed && product.orderConfirmedTimestamp > 0 && (
      <CountdownTimer
        deadline={product.orderConfirmedTimestamp + BID_WINDOW}
        windowSeconds={BID_WINDOW}
        label="Transporter selection deadline"
      />
    )}
    {product.phase === Phase.Bound && product.boundTimestamp > 0 && (
      <CountdownTimer
        deadline={product.boundTimestamp + DELIVERY_WINDOW}
        windowSeconds={DELIVERY_WINDOW}
        label="Delivery deadline"
      />
    )}

    {/* === PRIMARY ACTION PANEL (role-aware) === */}

    {/* SELLER: Confirm Order (phase=Purchased) */}
    {role.role === "seller" && product.phase === Phase.Purchased && (
      <div className="bg-amber-50 border border-amber-200 rounded-lg p-4">
        <h3 className="font-semibold text-amber-800 mb-2">Payment Received</h3>
        <p className="text-sm text-amber-700 mb-3">A buyer has purchased this product. Confirm the order to proceed.</p>
        <Button onClick={handleConfirmOrder} disabled={actionLoading}>
          {actionLoading ? "Processing..." : "Confirm Order"}
        </Button>
      </div>
    )}

    {/* SELLER: Transporter Selection (phase=OrderConfirmed) */}
    {role.role === "seller" && product.phase === Phase.OrderConfirmed && (
      <div className="bg-white border rounded-lg p-4">
        <h3 className="font-semibold mb-3">Select Transporter</h3>
        {bids.length === 0 ? (
          <p className="text-sm text-gray-500">No bids yet. Waiting for transporters to submit bids.</p>
        ) : (
          <table className="w-full text-sm">
            <thead><tr className="border-b">
              <th className="text-left py-2">Address</th>
              <th className="text-left py-2">Fee (ETH)</th>
              <th className="text-right py-2">Action</th>
            </tr></thead>
            <tbody>
              {bids
                .sort((a, b) => Number(a.fee - b.fee))
                .map((bid, i) => (
                  <tr key={bid.address} className="border-b">
                    <td className="py-2 font-mono text-xs">
                      {bid.address.slice(0,6)}...{bid.address.slice(-4)}
                      {i === 0 && <span className="ml-2 text-xs bg-green-100 text-green-700 px-1 rounded">Lowest</span>}
                    </td>
                    <td className="py-2">{ethers.formatEther(bid.fee)}</td>
                    <td className="py-2 text-right">
                      <Button size="sm" onClick={() => openTransporterConfirm(bid)} disabled={actionLoading}>
                        Select
                      </Button>
                    </td>
                  </tr>
                ))}
            </tbody>
          </table>
        )}
      </div>
    )}

    {/* BUYER: Buy with Railgun (phase=Listed) */}
    {role.role === "visitor" && product.phase === Phase.Listed && (
      <Button onClick={() => setShowPrivatePaymentModal(true)} className="bg-purple-600 hover:bg-purple-700">
        Buy with Railgun
      </Button>
    )}

    {/* BUYER: Post-purchase payment details card (phase >= Purchased, role=buyer) */}
    {role.role === "buyer" && product.phase >= Phase.Purchased && (
      <div className="bg-green-50 border border-green-200 rounded-lg p-4 space-y-3">
        <h3 className="font-semibold text-green-800">Payment Recorded</h3>
        <p className="text-sm text-green-700">Your private payment has been recorded on-chain.</p>

        {/* Memo Hash display with truncation + copy */}
        {product.memoHash && product.memoHash !== ethers.ZeroHash && (
          <div className="flex items-center gap-2">
            <span className="text-xs text-gray-500 w-20 shrink-0">Memo Hash:</span>
            <code className="text-xs font-mono text-gray-700 bg-gray-100 px-2 py-1 rounded truncate">
              {product.memoHash.slice(0, 10)}...{product.memoHash.slice(-8)}
            </code>
            <CopyButton value={product.memoHash} />
          </div>
        )}

        {/* Railgun TxRef display with truncation + copy */}
        {product.railgunTxRef && product.railgunTxRef !== ethers.ZeroHash && (
          <div className="flex items-center gap-2">
            <span className="text-xs text-gray-500 w-20 shrink-0">Tx Ref:</span>
            <code className="text-xs font-mono text-gray-700 bg-gray-100 px-2 py-1 rounded truncate">
              {product.railgunTxRef.slice(0, 10)}...{product.railgunTxRef.slice(-8)}
            </code>
            <CopyButton value={product.railgunTxRef} />
          </div>
        )}
      </div>
    )}

    {/* HASH DISPLAY (phase >= OrderConfirmed, seller/buyer/transporter) */}
    {product.phase >= Phase.OrderConfirmed && product.vcHash && product.vcHash !== ethers.ZeroHash && (
      (role.role === "seller" || (role.role === "buyer" && product.phase >= Phase.Bound) || role.role === "transporter") && (
        <HashDisplay
          hash={product.vcHash}
          label="Delivery Verification Hash"
          guidance={role.role === "seller"
            ? "Share this hash with the selected transporter. The transporter must use this exact value in confirmDelivery."
            : role.role === "transporter"
            ? "Use this hash to confirm delivery on-chain."
            : "This hash will be used by the transporter to confirm delivery."}
        />
      )
    )}

    {/* Transporter Confirmation Modal (styled, replaces window.confirm) */}
    {showTransporterConfirm && (
      <div className="fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center z-50">
        <div className="bg-white rounded-lg p-6 max-w-sm mx-4 shadow-xl">
          <h3 className="text-lg font-semibold mb-3">Confirm Transporter Selection</h3>
          <p className="text-sm text-gray-600 mb-2">
            You are selecting transporter:
          </p>
          <p className="font-mono text-xs bg-gray-100 px-2 py-1 rounded mb-3">
            {showTransporterConfirm.address}
          </p>
          <p className="text-sm text-gray-600 mb-1">
            Delivery fee deposit:
          </p>
          <p className="text-lg font-semibold text-blue-700 mb-4">
            {ethers.formatEther(showTransporterConfirm.fee)} ETH
          </p>
          <p className="text-xs text-gray-500 mb-4">
            This fee will be held in escrow and paid to the transporter upon successful delivery.
          </p>
          <div className="flex gap-3 justify-end">
            <Button variant="outline" onClick={() => setShowTransporterConfirm(null)}>
              Cancel
            </Button>
            <Button onClick={handleSelectTransporter} disabled={actionLoading}>
              {actionLoading ? "Processing..." : "Confirm & Deposit Fee"}
            </Button>
          </div>
        </div>
      </div>
    )}

    {/* PrivatePaymentModal */}
    {showPrivatePaymentModal && (
      <PrivatePaymentModal
        product={product}
        isOpen={showPrivatePaymentModal}
        onClose={() => setShowPrivatePaymentModal(false)}
        onSuccess={() => { setShowPrivatePaymentModal(false); loadProductData(); }}
        currentUser={currentUser}
      />
    )}

    {error && <p className="text-red-600">{error}</p>}
  </div>
);
```

**CopyButton helper** (define as small inline component or at top of file):
```javascript
const CopyButton = ({ value }) => {
  const [copied, setCopied] = useState(false);
  const handleCopy = () => {
    navigator.clipboard.writeText(value);
    setCopied(true);
    setTimeout(() => setCopied(false), 2000);
  };
  return (
    <button onClick={handleCopy} className="text-xs text-blue-600 hover:text-blue-800 shrink-0">
      {copied ? "Copied!" : "Copy"}
    </button>
  );
};
```

**Phase color mapping** (define as helper inside component or above render):
```javascript
const phaseColors = {
  [Phase.Listed]: "bg-gray-100 text-gray-700",
  [Phase.Purchased]: "bg-purple-100 text-purple-700",
  [Phase.OrderConfirmed]: "bg-orange-100 text-orange-800",
  [Phase.Bound]: "bg-blue-100 text-blue-700",
  [Phase.Delivered]: "bg-green-100 text-green-700",
  [Phase.Expired]: "bg-red-100 text-red-700",
};
const phaseColor = phaseColors[product.phase] || "bg-gray-100 text-gray-700";
```

Note: The transporter action panel (bid submission, delivery confirmation) is handled in Plan 05. This plan focuses on seller + buyer + shared display. Leave a comment `{/* Transporter actions -- see Plan 05 */}` where the transporter panel will go.
  </action>
  <verify>
    - File has PhaseTimeline, HashDisplay, CountdownTimer, BondCard rendered
    - Seller confirm order handler uses `product.memoHash` and `product.railgunTxRef` (NOT placeholder zeros)
    - `grep "product.memoHash" frontend/src/components/marketplace/ProductDetail.jsx` returns match
    - `grep "product.railgunTxRef" frontend/src/components/marketplace/ProductDetail.jsx` returns match
    - `grep -c '"0x" + "0"' frontend/src/components/marketplace/ProductDetail.jsx` returns 0 (no placeholder zeros)
    - Buyer post-purchase card displays memoHash and railgunTxRef with copy buttons
    - `grep "CopyButton" frontend/src/components/marketplace/ProductDetail.jsx` returns matches
    - Transporter selection uses styled modal (showTransporterConfirm state), NOT window.confirm
    - `grep -c "window.confirm" frontend/src/components/marketplace/ProductDetail.jsx` returns 0
    - `wc -l frontend/src/components/marketplace/ProductDetail.jsx` is under 900 lines
    - `cd frontend && npx react-scripts build 2>&1 | tail -5` -- builds without errors
  </verify>
  <done>ProductDetail.jsx rewritten: ~600-800 lines (down from 2100), uses escrowHelpers for all contract interaction, role-aware panels for seller (confirm order with real memoHash/txRef, select transporter via styled modal) and buyer (buy, post-purchase card with payment proof details + copy buttons), shared PhaseTimeline + HashDisplay + CountdownTimer. All dead code from old flow removed.</done>
</task>

</tasks>

<verification>
- No references to deprecated functions: buildStage2VC, buildStage3VC, revealAndConfirmDelivery, confirmOrderWithCommitment
- No references to IS_RAILGUN_API_CONFIGURED or RAILGUN_API_BASE
- ProductDetail uses getProductState for all contract reads
- Role detection uses detectRole from escrowHelpers
- Seller confirm order creates v2.0 VC with real memoHash/railgunTxRef from product state (not placeholder zeros)
- Buyer post-purchase card shows truncated memoHash + railgunTxRef with copy buttons
- Transporter selection uses styled modal overlay (not window.confirm)
- Phase timeline renders at top
- Hash display renders when phase >= OrderConfirmed
- Countdown timers show for appropriate phases
- File size reduced significantly (under 900 lines)
</verification>

<success_criteria>
- Seller sees sticky CTA "Payment Received -- Confirm Order" when phase is Purchased
- Seller confirm is 1-click: VC sign + IPFS upload + on-chain confirmOrder, using real on-chain memoHash/railgunTxRef
- Seller sees sortable bid table with "Lowest" badge when phase is OrderConfirmed
- Seller can select transporter via styled confirmation modal showing fee amount and transporter address
- Buyer sees "Buy with Railgun" when phase is Listed
- Buyer sees "Payment Recorded" card with truncated memoHash/txRef and copy buttons after purchase
- Hash display with QR visible to seller after confirmOrder, to buyer/transporter after transporter bound
- All countdowns show correct deadlines with color transitions
- No window.confirm calls anywhere in the file
</success_criteria>

<output>
After completion, create `.planning/phases/09-ui-rework/09-04-SUMMARY.md`
</output>
