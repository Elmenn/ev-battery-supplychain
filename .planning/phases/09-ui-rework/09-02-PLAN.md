---
phase: 09-ui-rework
plan: 02
type: execute
wave: 1
depends_on: []
files_modified:
  - frontend/src/views/MarketplaceView.jsx
  - frontend/src/components/marketplace/ProductCard.jsx
autonomous: true

must_haves:
  truths:
    - "MarketplaceView reads phase from contract instead of using publicPriceWei"
    - "MarketplaceView has transporter filter tabs: Needs Transporter, My Bids, Assigned to Me"
    - "ProductCard shows dual badges: primary phase badge + secondary role-aware action chip"
    - "Price display shows 'Private' for all products (no public price)"
    - "All filter tabs filter correctly based on contract phase and current user address"
  artifacts:
    - path: "frontend/src/views/MarketplaceView.jsx"
      provides: "Updated marketplace with phase-based loading and transporter filters"
      min_lines: 100
    - path: "frontend/src/components/marketplace/ProductCard.jsx"
      provides: "Phase-aware card with dual badges"
      min_lines: 50
  key_links:
    - from: "frontend/src/views/MarketplaceView.jsx"
      to: "frontend/src/abis/ProductEscrow_Initializer.json"
      via: "contract phase read"
      pattern: "phase\\(\\)"
    - from: "frontend/src/components/marketplace/ProductCard.jsx"
      to: "frontend/src/views/MarketplaceView.jsx"
      via: "product prop with phase field"
      pattern: "product\\.phase"
---

<objective>
Update MarketplaceView and ProductCard to use the new contract's phase enum, remove dead publicPriceWei reads, add transporter-oriented filter tabs, and implement dual-badge display on cards.

Purpose: The marketplace grid is the entry point for all users. Transporters need filter tabs to discover delivery jobs. Cards must reflect the new 6-phase lifecycle accurately.

Output: Updated MarketplaceView.jsx with 6 filter tabs + updated ProductCard.jsx with phase-based dual badges
</objective>

<execution_context>
@~/.claude/get-shit-done/workflows/execute-plan.md
@~/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/09-ui-rework/09-RESEARCH.md

@frontend/src/views/MarketplaceView.jsx
@frontend/src/components/marketplace/ProductCard.jsx
@frontend/src/abis/ProductEscrow_Initializer.json
</context>

<tasks>

<task type="auto">
  <name>Task 1: Update MarketplaceView product loading and filter tabs</name>
  <files>frontend/src/views/MarketplaceView.jsx</files>
  <action>
Rewrite the product loading and filtering logic in MarketplaceView.jsx:

**Product loading changes (useEffect):**
1. REMOVE the `publicPriceWei` read -- this getter no longer exists on the contract. It will throw.
2. Instead, set `price: "Private"` for all products (private-only marketplace).
3. ADD `phase` read: call `pc.phase()` and store as `Number(phase)` in the product object.
4. ADD `bondAmount` read: call `pc.bondAmount()` and store as BigInt.
5. ADD `deliveryFee` read: call `pc.deliveryFee()` and store as BigInt.
6. ADD `sellerBond` read: call `pc.sellerBond()` and store as BigInt.
7. For transporter filter, also read: `pc.getAllTransporters()` -- returns [addresses[], fees[]]. Store as `transporterAddresses` and `transporterFees` arrays on the product object.
8. Keep all existing reads (name, owner, purchased, buyer, vcHash, transporter) but wrap ALL reads in a single Promise.all for performance.
9. Remove the `publicPriceWei` field from the product object entirely.

**Filter tabs replacement:**
Replace the current 3 filters (All, My Listings, Purchased) with 6 filters:
```javascript
const filters = [
  { id: "all", label: "All" },
  { id: "my", label: "My Listings" },
  { id: "purchased", label: "My Purchases" },
  { id: "needs-transporter", label: "Needs Transporter" },
  { id: "my-bids", label: "My Bids" },
  { id: "assigned", label: "Assigned to Me" },
];
```

**Filter logic:**
- `all`: show everything (no filter)
- `my`: `p.owner === myAddress?.toLowerCase()`
- `purchased`: `p.buyer === myAddress?.toLowerCase()` (and buyer is not ZeroAddress)
- `needs-transporter`: `p.phase === 2` (OrderConfirmed -- transporters can bid)
- `my-bids`: `p.transporterAddresses?.some(addr => addr.toLowerCase() === myAddress?.toLowerCase())` -- current user has placed a bid on this product
- `assigned`: `p.transporter?.toLowerCase() === myAddress?.toLowerCase()` and transporter is not ZeroAddress

The filter pills should wrap naturally on mobile. Keep the existing Tailwind styling pattern (rounded-md px-3 py-1 text-sm).

**Other cleanup:**
- Remove the `privatePaymentsEnabled` computed field (everything is private now).
- Keep localStorage reads for sellerRailgunAddress and sellerWalletID (still used for private payment flow).
- Remove `priceBlinding` localStorage read (not used in new flow).
  </action>
  <verify>
    - MarketplaceView.jsx has no reference to `publicPriceWei`
    - File contains all 6 filter IDs: all, my, purchased, needs-transporter, my-bids, assigned
    - `grep -c "publicPriceWei" frontend/src/views/MarketplaceView.jsx` returns 0
    - `grep -c "phase" frontend/src/views/MarketplaceView.jsx` returns multiple matches
  </verify>
  <done>MarketplaceView loads phase from contract, removes publicPriceWei dead code, and shows 6 filter tabs including transporter discovery filters.</done>
</task>

<task type="auto">
  <name>Task 2: Update ProductCard with phase-based dual badges</name>
  <files>frontend/src/components/marketplace/ProductCard.jsx</files>
  <action>
Rewrite ProductCard.jsx to use the contract phase enum for badge display:

**Props update:**
- Add `myAddress` to destructured props (already passed from MarketplaceView)
- Product object now has `phase` (number 0-5), `transporterAddresses`, `bondAmount`

**Primary badge (phase-based, always shown):**
Map the phase number to badge:
```
Phase 0 (Listed):          bg-gray-100 text-gray-700     "Listed"
Phase 1 (Purchased):       bg-purple-100 text-purple-700  "Purchased"
Phase 2 (OrderConfirmed):  bg-orange-100 text-orange-800  "Order Confirmed"
Phase 3 (Bound):           bg-blue-100 text-blue-700      "In Delivery"
Phase 4 (Delivered):       bg-green-100 text-green-700    "Delivered"
Phase 5 (Expired):         bg-red-100 text-red-700        "Expired"
```

**Secondary badge (role-aware action chip, only when wallet connected):**
Only show if `myAddress` is set. Determine role:
- If myAddress === product.owner: show seller-specific chip based on phase
  - Phase 1: "Confirm Order" chip (amber bg)
  - Phase 2: "Select Transporter" chip (amber bg)
- If myAddress === product.buyer: show buyer-specific chip
  - Phase 3+: "In Transit" chip (blue bg)
- If myAddress is in transporterAddresses: show transporter chip
  - Phase 2: "Bid Placed" chip (cyan bg)
- If myAddress === product.transporter: show assigned transporter chip
  - Phase 3: "Deliver" chip (emerald bg)
- Otherwise: no secondary badge

The secondary badge should be smaller (text-2xs or text-[10px]) and positioned below the primary badge.

**Price display:**
- Remove the conditional `product.price === "Price hidden"` check. All products now show "Private" as the price. Keep it simple: `<span>Private</span>`.

**Remove dead code:**
- Remove `ownerIsBuyer` logic (was heuristic for delivered status; now use `product.phase === 4`)
- Remove old badge computation based on purchased/buyer/transporter booleans
- Keep the navigate to `/product/${product.address}` on View Details button

**Button text:** Change "View Details & Buy" to just "View Details" (buying happens inside ProductDetail).
  </action>
  <verify>
    - ProductCard.jsx uses `product.phase` for primary badge (not boolean heuristics)
    - No reference to `publicPriceWei` or `ownerIsBuyer`
    - `grep "product.phase" frontend/src/components/marketplace/ProductCard.jsx` returns matches
    - Build succeeds: `cd frontend && npx react-scripts build 2>&1 | tail -5`
  </verify>
  <done>ProductCard shows phase-based primary badge (6 states) and role-aware secondary action chip when wallet is connected. No dead code from old purchase flow.</done>
</task>

</tasks>

<verification>
- MarketplaceView loads products with phase field from contract
- All 6 filter tabs render and filter correctly
- ProductCard uses phase enum for badges (not boolean heuristics)
- No references to publicPriceWei, ownerIsBuyer, or old badge logic
- Frontend builds without errors
</verification>

<success_criteria>
- Transporter can filter marketplace to see "Needs Transporter" products (phase 2)
- Transporter can see "My Bids" and "Assigned to Me" products
- ProductCard primary badge accurately reflects contract phase
- Secondary badge shows role-specific action hint when wallet connected
- Price shows "Private" for all products
</success_criteria>

<output>
After completion, create `.planning/phases/09-ui-rework/09-02-SUMMARY.md`
</output>
