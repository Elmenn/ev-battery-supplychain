---
phase: 09-ui-rework
plan: 03
type: execute
wave: 1
depends_on: []
files_modified:
  - frontend/src/components/marketplace/ProductFormStep3.jsx
  - frontend/src/utils/web3Utils.js
autonomous: true

must_haves:
  truths:
    - "ProductFormStep3 shows bond amount before deployment with confirmation modal"
    - "ProductFormStep3 uses createListingVC from vcBuilder.mjs (v2.0) instead of manually building VC"
    - "web3Utils.confirmOrder calls contract.confirmOrder(vcCID) -- not confirmOrderWithCommitment"
    - "web3Utils removes Web3.js dependency (use ethers only)"
  artifacts:
    - path: "frontend/src/components/marketplace/ProductFormStep3.jsx"
      provides: "Seller product creation with bond disclosure"
      min_lines: 200
    - path: "frontend/src/utils/web3Utils.js"
      provides: "Simplified confirmOrder and getTransporters using ethers v6"
      exports: ["confirmOrder", "getCurrentCid", "getTransporters", "ethersProvider"]
  key_links:
    - from: "frontend/src/components/marketplace/ProductFormStep3.jsx"
      to: "frontend/src/utils/vcBuilder.mjs"
      via: "createListingVC import"
      pattern: "import.*createListingVC.*vcBuilder"
    - from: "frontend/src/utils/web3Utils.js"
      to: "frontend/src/abis/ProductEscrow_Initializer.json"
      via: "confirmOrder(vcCID)"
      pattern: "contract\\.confirmOrder\\(.*\\)"
---

<objective>
Update the seller product creation flow (ProductFormStep3) to display bond disclosure before deployment and use the v2.0 VC builder. Simplify web3Utils.js to use the new contract interface.

Purpose: Sellers must see and confirm the bond amount before locking ETH. The VC creation must use the new append-only createListingVC. web3Utils still has references to confirmOrderWithCommitment which no longer exists.

Output: Updated ProductFormStep3.jsx with bond modal + updated web3Utils.js with simplified confirmOrder
</objective>

<execution_context>
@~/.claude/get-shit-done/workflows/execute-plan.md
@~/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/09-ui-rework/09-RESEARCH.md

@frontend/src/components/marketplace/ProductFormStep3.jsx
@frontend/src/utils/web3Utils.js
@frontend/src/utils/vcBuilder.mjs
@frontend/src/utils/signVcWithMetamask.js
@frontend/src/utils/commitmentUtils.js
</context>

<tasks>

<task type="auto">
  <name>Task 1: Add bond disclosure to ProductFormStep3 and switch to v2.0 VC</name>
  <files>frontend/src/components/marketplace/ProductFormStep3.jsx</files>
  <action>
Modify ProductFormStep3.jsx with these changes:

**1. Bond disclosure card (before the Confirm button):**
Add a read-only "Protocol Collateral" card in the review section showing:
- Bond amount read from the factory contract (fetch `factory.bondAmount()` on mount via useEffect, store in state)
- Display formatted as ETH: `ethers.formatEther(bondAmount)`
- Yellow/amber background card with shield icon (use lucide-react `Shield`)
- Text: "You will lock {X} ETH as seller bond. This is refundable upon successful delivery completion. Bond will be slashed if you fail to confirm the order within the timeout window."
- If bondAmount is loading, show a skeleton/placeholder

**2. Confirmation modal before transaction:**
Add a state `showBondConfirm` (boolean). When user clicks "Confirm & Deploy":
- Instead of immediately calling handleConfirm, show a modal:
  - Title: "Confirm Bond Deposit"
  - Body: "You are about to lock {X} ETH as seller bond and deploy a new product escrow. This bond is refundable after successful delivery."
  - Two buttons: "Cancel" (closes modal) and "Confirm & Lock Bond" (calls handleConfirm and closes modal)
- Use the existing modal pattern (fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center z-50)

**3. Switch to createListingVC (v2.0):**
The current code manually builds a VC object. Replace with:
```javascript
import { createListingVC } from "../../utils/vcBuilder.mjs";
```
After product deployment succeeds and Pedersen commitment is generated, call:
```javascript
const vc = createListingVC({
  sellerAddr,
  productContract: validatedProductAddress,
  productName: productData.productName,
  chainId: VC_CHAIN,
  priceCommitment: pedersenCommitment,
  batch: productData.batch || "",
  quantity: productData.quantity || 1,
  componentCredentials: productData.componentCredentials || [],
});
```
Then sign with `signVcAsSeller` and upload to IPFS as before.

IMPORTANT: Keep the existing Pedersen commitment generation flow (it works). Only replace the VC construction portion. The commitment data (commitment, proof, bindingTag) should be stored in the VC's `priceCommitment` field which createListingVC already handles.

NOTE: If createListingVC doesn't accept all these fields, adapt the call to match its actual signature. Read vcBuilder.mjs to confirm the function signature before writing code.

**4. Cleanup:**
- Remove the manually constructed `vcPreview` object at the top (replaced by createListingVC)
- Keep the collapsible "Show Full VC Structure" section but have it display the VC returned by createListingVC
- Convert inline styles to Tailwind classes where straightforward (the summary card, buttons)
  </action>
  <verify>
    - `grep "createListingVC" frontend/src/components/marketplace/ProductFormStep3.jsx` returns match
    - `grep "bondAmount" frontend/src/components/marketplace/ProductFormStep3.jsx` returns multiple matches (state + display)
    - `grep "showBondConfirm" frontend/src/components/marketplace/ProductFormStep3.jsx` returns matches
    - No reference to old manual VC construction pattern (`vcPreview` object removed or replaced)
  </verify>
  <done>ProductFormStep3 shows bond amount before deployment, requires confirmation modal, and uses createListingVC from v2.0 vcBuilder.</done>
</task>

<task type="auto">
  <name>Task 2: Simplify web3Utils.js for new contract interface</name>
  <files>frontend/src/utils/web3Utils.js</files>
  <action>
Rewrite web3Utils.js:

**1. Remove confirmOrderWithCommitment logic:**
The current `confirmOrder` function checks for `confirmOrderWithCommitment` and has complex bytes32 commitment formatting. The new contract only has `confirmOrder(vcCID)` which takes a string (the IPFS CID). Simplify to:
```javascript
export async function confirmOrder(escrowAddress, vcCID) {
  const signer = await getSigner();
  const escrow = new Contract(escrowAddress, ProductEscrowABI.abi, signer);
  const tx = await escrow.confirmOrder(vcCID);
  return tx;
}
```
Where `getSigner()` is a helper:
```javascript
async function getSigner() {
  if (window.ethereum) {
    await window.ethereum.request({ method: "eth_requestAccounts" });
    const browserProvider = new BrowserProvider(window.ethereum);
    return browserProvider.getSigner();
  }
  if (process.env.REACT_APP_SELLER_PK) {
    return new Wallet(process.env.REACT_APP_SELLER_PK, ethersProvider);
  }
  throw new Error("No signer available: install MetaMask or set REACT_APP_SELLER_PK");
}
```

Remove the `purchaseTxHashCommitment` parameter entirely. Remove the debug logging (phase, owner, etc.) -- keep it clean.

**2. Remove Web3.js dependency:**
The current `getTransporters` uses `web3.eth.Contract`. Rewrite using ethers v6:
```javascript
export async function getTransporters(productAddress) {
  try {
    const escrow = new Contract(productAddress, ProductEscrowABI.abi, ethersProvider);
    const [addresses, fees] = await escrow.getAllTransporters();
    return [addresses, fees];
  } catch (err) {
    console.error("getTransporters error:", err);
    return [[], []];
  }
}
```
Remove the `import Web3 from "web3"` and the `export const web3 = ...` line. Also remove `getBytes` and `hexlify` from the ethers import (no longer needed).

**3. Keep getCurrentCid as is** -- it already correctly calls `getVcHash()`.

**4. Keep ethersProvider export** -- other modules may use it.

Final imports should be: `import { JsonRpcProvider, BrowserProvider, Wallet, Contract } from "ethers";`
  </action>
  <verify>
    - `grep "Web3" frontend/src/utils/web3Utils.js` returns 0 matches
    - `grep "confirmOrderWithCommitment" frontend/src/utils/web3Utils.js` returns 0 matches
    - `grep "getBytes\|hexlify" frontend/src/utils/web3Utils.js` returns 0 matches
    - File still exports: confirmOrder, getCurrentCid, getTransporters, ethersProvider
  </verify>
  <done>web3Utils.js uses new contract interface (confirmOrder with string CID, no commitment param), ethers-only (no Web3.js), clean imports.</done>
</task>

</tasks>

<verification>
- ProductFormStep3 shows bond amount before user clicks deploy
- Bond confirmation modal appears before transaction
- VC creation uses createListingVC (v2.0 pattern)
- web3Utils.confirmOrder calls contract.confirmOrder(vcCID) only
- No Web3.js references remain in web3Utils.js
- Frontend builds without errors
</verification>

<success_criteria>
- Seller sees exact bond amount in ETH before committing to product creation
- Seller must confirm bond deposit via modal (not accidental deployment)
- VC created during product listing uses v2.0 schema (append-only pattern)
- confirmOrder function matches new contract signature
</success_criteria>

<output>
After completion, create `.planning/phases/09-ui-rework/09-03-SUMMARY.md`
</output>
