---
phase: 06-on-chain-recording
plan: 02
type: execute
wave: 2
depends_on: ["06-01"]
files_modified:
  - frontend/src/components/marketplace/ProductCard.jsx
  - frontend/src/components/marketplace/ProductDetail.jsx
autonomous: false

must_haves:
  truths:
    - "Product shows 'Purchased' badge on marketplace cards after private payment"
    - "ProductDetail shows 'Already Purchased' disabled button when purchased"
    - "Transaction references (txHash, memoHash) are visible on ProductDetail"
    - "Full flow works end-to-end: private transfer -> recording -> UI update"
  artifacts:
    - path: "frontend/src/components/marketplace/ProductCard.jsx"
      provides: "Purchased badge for private purchases"
      contains: "Purchased"
    - path: "frontend/src/components/marketplace/ProductDetail.jsx"
      provides: "Disabled button and transaction references"
      contains: "Already Purchased"
  key_links:
    - from: "ProductCard.jsx"
      to: "product.purchased"
      via: "badge logic"
      pattern: "product\\.purchased"
    - from: "ProductDetail.jsx"
      to: "localStorage pending_private_payment"
      via: "transaction reference display"
      pattern: "pending_private_payment"
---

<objective>
Update marketplace UI to reflect purchased state after on-chain recording completes.

Purpose: User confirmation that the full private payment flow worked - they can see the product is purchased and view transaction references.

Output: ProductCard shows "Purchased" badge, ProductDetail shows disabled button and transaction hashes.
</objective>

<execution_context>
@~/.claude/get-shit-done/workflows/execute-plan.md
@~/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/06-on-chain-recording/06-01-SUMMARY.md
@.planning/phases/06-on-chain-recording/06-RESEARCH.md

Key existing code:
- `frontend/src/components/marketplace/ProductCard.jsx` - Badge logic lines 19-31
- `frontend/src/components/marketplace/ProductDetail.jsx` - Product display and actions
</context>

<tasks>

<task type="auto">
  <name>Task 1: Update ProductCard badge for purchased state</name>
  <files>frontend/src/components/marketplace/ProductCard.jsx</files>
  <action>
Update the badge logic (lines 19-31) to show a clear "Purchased" badge when a product is purchased.

**Current logic has this order:**
1. ownerIsBuyer -> "Delivered"
2. hasTransporter -> "In Delivery"
3. product.purchased -> "Awaiting Transporter"
4. hasBuyer -> "Awaiting Confirm"
5. else -> "Available"

**Problem:** "Awaiting Transporter" is confusing for users. They want to see "Purchased" clearly.

**Update to:**
1. ownerIsBuyer -> "Delivered" (green)
2. hasTransporter -> "In Delivery" (blue)
3. product.purchased -> "Purchased" (purple) - CHANGE THIS
4. hasBuyer -> "Awaiting Confirm" (orange)
5. else -> "Available" (gray)

Change line 25-29 from:
```javascript
else if (product.purchased)
  badge = {
    text: "Awaiting Transporter",
    cls: "bg-yellow-100 text-yellow-800",
  };
```

To:
```javascript
else if (product.purchased)
  badge = {
    text: "Purchased",
    cls: "bg-purple-100 text-purple-700",
  };
```

Purple color matches the privacy theme (Railgun = purple/privacy).
  </action>
  <verify>
`grep -n "Purchased" frontend/src/components/marketplace/ProductCard.jsx`
Expected: Line with "Purchased" badge text found
  </verify>
  <done>
ProductCard badge shows "Purchased" with purple styling when product.purchased is true
  </done>
</task>

<task type="auto">
  <name>Task 2: Update ProductDetail for purchased state and transaction display</name>
  <files>frontend/src/components/marketplace/ProductDetail.jsx</files>
  <action>
Add two features:
1. Show "Already Purchased" disabled button when product is purchased
2. Display transaction references (txHash, recordTxHash, memoHash) after purchase

**Part A: Disabled button for purchased products**

Find the "Pay with Private Funds" button section. Add a condition to show disabled button when purchased:

```javascript
{product?.purchased ? (
  <Button
    disabled
    className="w-full bg-gray-300 text-gray-600 cursor-not-allowed"
  >
    Already Purchased
  </Button>
) : (
  // existing Pay with Private Funds button
)}
```

**Part B: Transaction reference display**

Add a section to display transaction references from localStorage when product is purchased.

After the action buttons section, add:

```javascript
{/* Transaction References (show after purchase) */}
{product?.purchased && (() => {
  const pendingKey = `pending_private_payment_${address}`;
  const pendingRaw = localStorage.getItem(pendingKey);
  if (!pendingRaw) return null;

  const pending = JSON.parse(pendingRaw);
  if (pending.status !== 'confirmed') return null;

  const chainId = 11155111; // Sepolia
  const transferUrl = pending.txHash ? `https://sepolia.etherscan.io/tx/${pending.txHash}` : null;
  const recordUrl = pending.recordTxHash ? `https://sepolia.etherscan.io/tx/${pending.recordTxHash}` : null;

  return (
    <div className="mt-4 p-4 bg-purple-50 rounded-lg border border-purple-200">
      <h4 className="font-semibold text-purple-800 mb-2">Private Payment Details</h4>
      <div className="space-y-2 text-sm">
        {pending.txHash && (
          <div>
            <span className="font-medium">Railgun Transfer:</span>{' '}
            <a href={transferUrl} target="_blank" rel="noreferrer" className="text-blue-600 hover:underline">
              {pending.txHash.slice(0, 10)}...{pending.txHash.slice(-8)}
            </a>
          </div>
        )}
        {pending.recordTxHash && (
          <div>
            <span className="font-medium">On-Chain Recording:</span>{' '}
            <a href={recordUrl} target="_blank" rel="noreferrer" className="text-blue-600 hover:underline">
              {pending.recordTxHash.slice(0, 10)}...{pending.recordTxHash.slice(-8)}
            </a>
          </div>
        )}
        {pending.memoHash && (
          <div>
            <span className="font-medium">Memo Hash:</span>{' '}
            <span className="font-mono text-xs">{pending.memoHash.slice(0, 18)}...</span>
          </div>
        )}
      </div>
    </div>
  );
})()}
```

This uses an IIFE to read localStorage and render conditionally. The styling matches the privacy/purple theme.

**Note:** Find the appropriate location in the JSX - typically after the purchase buttons section but before the VC chain display.
  </action>
  <verify>
1. `grep -n "Already Purchased" frontend/src/components/marketplace/ProductDetail.jsx`
   Expected: Disabled button text found

2. `grep -n "Private Payment Details" frontend/src/components/marketplace/ProductDetail.jsx`
   Expected: Transaction reference section found

3. `grep -n "recordTxHash" frontend/src/components/marketplace/ProductDetail.jsx`
   Expected: On-chain recording tx display found
  </verify>
  <done>
ProductDetail shows "Already Purchased" disabled button when purchased, displays transaction references (Railgun transfer, on-chain recording, memo hash) with Etherscan links
  </done>
</task>

<task type="checkpoint:human-verify" gate="blocking">
  <what-built>
Full private payment flow with on-chain recording and UI feedback:
- Plan 1: recordPrivatePayment called after privateTransfer
- Plan 2: UI updated to show purchased state
  </what-built>
  <how-to-verify>
**End-to-end test on Sepolia:**

1. Prerequisites:
   - Have a product listed with private payments enabled
   - Have a buyer wallet with shielded WETH balance
   - Seller has Railgun wallet connected (for receiving)

2. Execute private payment:
   - Navigate to product detail page
   - Click "Pay with Private Funds" button
   - Complete Railgun transfer (20-30 second proof generation)
   - **Observe:** After transfer, MetaMask should prompt for second transaction (recordPrivatePayment)
   - Confirm the recording transaction

3. Verify success indicators:
   - [ ] Success toast appears with "Private payment recorded on-chain!"
   - [ ] Toast contains clickable Etherscan link
   - [ ] Click link opens Sepolia Etherscan showing recordPrivatePayment transaction
   - [ ] Product page refreshes to show purchased state

4. Verify UI updates:
   - [ ] "Pay with Private Funds" button replaced by "Already Purchased" (disabled, gray)
   - [ ] Purple "Private Payment Details" box appears with:
     - Railgun Transfer tx hash (clickable Etherscan link)
     - On-Chain Recording tx hash (clickable Etherscan link)
     - Memo Hash (truncated)

5. Verify marketplace card:
   - [ ] Navigate to marketplace list
   - [ ] Product shows purple "Purchased" badge (not "Awaiting Transporter")

6. Verify contract state:
   - [ ] On Etherscan, check product contract
   - [ ] `purchased()` returns true
   - [ ] `purchaseMode()` returns 2 (Private)
   - [ ] `phase()` returns 1 (Purchased)

**Error scenarios to test (optional):**
- Try purchasing again -> Should see "Already Purchased" button
- If recording fails -> Should see specific error message (not generic)
  </how-to-verify>
  <resume-signal>Type "approved" if all checks pass, or describe any issues found</resume-signal>
</task>

</tasks>

<verification>
After tasks 1-2 complete (before checkpoint):

1. **Code check:**
   ```bash
   grep -n "Purchased" frontend/src/components/marketplace/ProductCard.jsx
   grep -n "Already Purchased" frontend/src/components/marketplace/ProductDetail.jsx
   grep -n "Private Payment Details" frontend/src/components/marketplace/ProductDetail.jsx
   ```

2. **Build check:** `cd frontend && npm run build`

3. **Visual check:** Start dev server and inspect marketplace card badge colors
</verification>

<success_criteria>
- [ ] ProductCard shows "Purchased" badge (purple) for purchased products
- [ ] ProductDetail shows "Already Purchased" disabled button
- [ ] Transaction references displayed with Etherscan links
- [ ] Build passes with no errors
- [ ] Human verification confirms full flow works end-to-end
</success_criteria>

<output>
After completion, create `.planning/phases/06-on-chain-recording/06-02-SUMMARY.md`
</output>
