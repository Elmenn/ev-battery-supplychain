---
phase: 03-eth-to-weth-wrapping
plan: 01
type: execute
wave: 1
depends_on: []
files_modified:
  - frontend/src/lib/railgun-clean/shield.js
autonomous: false

must_haves:
  truths:
    - "User can enter ETH amount in PrivateFundsDrawer"
    - "User clicks Wrap button and MetaMask prompts for transaction"
    - "Transaction confirms and WETH balance increases"
    - "No 'Signer required' error in console"
  artifacts:
    - path: "frontend/src/lib/railgun-clean/shield.js"
      provides: "wrapETHtoWETH with optional signer parameter"
      contains: "signer = null"
  key_links:
    - from: "PrivateFundsDrawer.jsx"
      to: "shield.js:wrapETHtoWETH"
      via: "import from railgun-clean"
      pattern: "wrapETHtoWETH\\(wrapAmt\\)"
    - from: "shield.js:wrapETHtoWETH"
      to: "window.ethereum"
      via: "BrowserProvider.getSigner()"
      pattern: "new ethers\\.BrowserProvider.*getSigner"
---

<objective>
Fix ETH to WETH wrapping by making the signer parameter optional

Purpose: The wrap function exists but fails because PrivateFundsDrawer calls it without a signer. Making signer optional enables the existing UI to work without code changes.

Output: Working wrap flow where user enters amount, clicks wrap, confirms in MetaMask, and WETH balance updates.
</objective>

<execution_context>
@~/.claude/get-shit-done/workflows/execute-plan.md
@~/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/03-eth-to-weth-wrapping/03-RESEARCH.md

# Key files
@frontend/src/lib/railgun-clean/shield.js
@frontend/src/components/railgun/PrivateFundsDrawer.jsx
</context>

<tasks>

<task type="auto">
  <name>Task 1: Make signer parameter optional in wrapETHtoWETH</name>
  <files>frontend/src/lib/railgun-clean/shield.js</files>
  <action>
Modify `wrapETHtoWETH()` function (starting line 16) to:

1. Change signature from `wrapETHtoWETH(amountEth, signer)` to `wrapETHtoWETH(amountEth, signer = null)`

2. Add signer resolution at start of function (before the existing `if (!signer)` check):
```javascript
// Get signer from MetaMask if not provided
if (!signer && typeof window !== 'undefined' && window.ethereum) {
  const provider = new ethers.BrowserProvider(window.ethereum);
  signer = await provider.getSigner();
}
```

3. Change error message from "Signer required for wrapETHtoWETH" to "MetaMask not connected" (more user-friendly)

4. Improve error handling in the catch block to handle ethers v6 error codes:
```javascript
} catch (error) {
  console.error('wrapETHtoWETH failed:', error);
  // Handle user rejection
  if (error.code === 'ACTION_REJECTED') {
    return { success: false, error: 'Transaction cancelled by user' };
  }
  // Handle insufficient funds
  if (error.code === 'INSUFFICIENT_FUNDS') {
    return { success: false, error: 'Insufficient ETH for gas and value' };
  }
  return { success: false, error: error.message };
}
```

Pattern reference: This matches `balances.js` pattern where provider is obtained internally.

DO NOT modify:
- The WETH contract interaction logic (lines 27-56) - it works correctly
- The exports at bottom of file
- The `shieldWETH`, `getWETHBalance`, or `estimateShieldWETH` functions
  </action>
  <verify>
1. `npm run build` in frontend directory - no TypeScript/compilation errors
2. Grep for "signer = null" in shield.js - confirms parameter is optional
3. Grep for "MetaMask not connected" in shield.js - confirms error message updated
  </verify>
  <done>
- wrapETHtoWETH accepts optional signer parameter
- Function obtains signer from window.ethereum when not provided
- Error messages are user-friendly (ACTION_REJECTED, INSUFFICIENT_FUNDS handled)
  </done>
</task>

<task type="checkpoint:human-verify" gate="blocking">
  <what-built>
ETH to WETH wrapping flow with automatic signer resolution
  </what-built>
  <how-to-verify>
1. Start frontend: `cd frontend && npm start`
2. Open http://localhost:3000 in browser with MetaMask
3. Ensure MetaMask is connected to Sepolia testnet
4. Ensure you have at least 0.02 ETH (0.01 for wrap + gas)
5. Connect Railgun wallet (if not already)
6. Click "Private Funds" button to open PrivateFundsDrawer
7. In "Wrap ETH -> WETH" section, enter 0.01 in the input
8. Click "Wrap ETH to WETH" button
9. MetaMask should prompt for transaction approval
10. Approve the transaction
11. Wait for confirmation
12. Verify:
    - Toast shows "ETH wrapped to WETH! TX: ..."
    - WETH balance under EOA (Public) increases by 0.01
    - No console errors about "Signer required"
  </how-to-verify>
  <resume-signal>Type "approved" if wrap works correctly, or describe the issue</resume-signal>
</task>

</tasks>

<verification>
- `npm run build` passes in frontend directory
- No "Signer required" errors in browser console
- Wrap transaction completes successfully
- Balance updates reflect wrapped amount
</verification>

<success_criteria>
1. User can wrap 0.01 ETH to WETH without passing signer
2. MetaMask prompts for transaction confirmation
3. WETH balance shows increase after transaction confirms
4. No console errors during the flow
</success_criteria>

<output>
After completion, create `.planning/phases/03-eth-to-weth-wrapping/03-01-SUMMARY.md`
</output>
