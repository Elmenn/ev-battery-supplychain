---
phase: 02-wallet-connection
plan: 02
type: execute
wave: 2
depends_on: ["02-01"]
files_modified:
  - frontend/src/lib/railgun-clean/connection.js
  - frontend/src/components/railgun/RailgunConnectionButton.jsx
autonomous: false

must_haves:
  truths:
    - "User can copy Railgun address to clipboard"
    - "SDK initialization retries silently before showing error"
    - "User sees spinner during connection"
    - "Connection flow works end-to-end with encrypted storage"
  artifacts:
    - path: "frontend/src/components/railgun/RailgunConnectionButton.jsx"
      provides: "Connection button with copy, spinner, and improved UX"
      contains: "navigator.clipboard.writeText"
    - path: "frontend/src/lib/railgun-clean/connection.js"
      provides: "Retry wrapper for SDK initialization"
      contains: "withRetry"
  key_links:
    - from: "RailgunConnectionButton.jsx"
      to: "connection.js connectRailgun"
      via: "import and call"
      pattern: "import.*connectRailgun.*from"
    - from: "RailgunConnectionButton.jsx"
      to: "navigator.clipboard"
      via: "copyAddress handler"
      pattern: "navigator\\.clipboard\\.writeText"
---

<objective>
Improve wallet connection UX with copy button, retry logic, and visual feedback.

Purpose: CONTEXT.md specifies: copy button for address, spinner during connection, silent retry 2-3 times on SDK failure. This plan implements these UX improvements on top of the encrypted storage from Plan 01.

Output: Polished connection button that handles errors gracefully and provides clear feedback.
</objective>

<execution_context>
@~/.claude/get-shit-done/workflows/execute-plan.md
@~/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/02-wallet-connection/02-CONTEXT.md

# Depends on Plan 01 output
@.planning/phases/02-wallet-connection/02-01-SUMMARY.md

# Source files to modify
@frontend/src/components/railgun/RailgunConnectionButton.jsx
@frontend/src/lib/railgun-clean/connection.js
</context>

<tasks>

<task type="auto">
  <name>Task 1: Add retry wrapper to connection.js</name>
  <files>frontend/src/lib/railgun-clean/connection.js</files>
  <action>
Add retry utility and wrap SDK initialization:

1. Add retry helper at top of file:
```javascript
/**
 * Retry wrapper with exponential backoff
 * @param {Function} fn - Async function to retry
 * @param {number} maxRetries - Maximum retry attempts (default 3)
 * @param {number} baseDelay - Base delay in ms (default 1000)
 * @returns {Promise} Result of fn() or throws after all retries fail
 */
async function withRetry(fn, maxRetries = 3, baseDelay = 1000) {
  for (let attempt = 1; attempt <= maxRetries; attempt++) {
    try {
      return await fn();
    } catch (err) {
      console.warn(`Attempt ${attempt}/${maxRetries} failed:`, err.message);
      if (attempt === maxRetries) throw err;
      await new Promise(r => setTimeout(r, baseDelay * attempt));
    }
  }
}
```

2. Wrap SDK initialization in connectRailgun:
```javascript
// Replace direct call:
// const initRes = await client.initializeSDK();

// With retry wrapper:
const initRes = await withRetry(
  () => client.initializeSDK(),
  3,  // 3 attempts
  1000 // 1s, 2s, 3s backoff
);
```

3. Convert error messages to user-friendly format before returning:
```javascript
// In catch block, map technical errors to friendly messages
const friendlyMessage = err.message.includes('Failed to initialize')
  ? 'Connection failed. Please try again.'
  : err.message.includes('User rejected')
  ? 'Connection cancelled.'
  : 'Connection failed. Please try again.';

return { success: false, error: friendlyMessage };
```
  </action>
  <verify>
1. `grep "withRetry" frontend/src/lib/railgun-clean/connection.js` shows function definition
2. `grep "attempt.*maxRetries" frontend/src/lib/railgun-clean/connection.js` shows retry logic
  </verify>
  <done>connection.js has withRetry wrapper and uses it for SDK initialization</done>
</task>

<task type="auto">
  <name>Task 2: Update RailgunConnectionButton with copy button and improved UX</name>
  <files>frontend/src/components/railgun/RailgunConnectionButton.jsx</files>
  <action>
Improve the connection button component:

1. Add copy address handler:
```javascript
const copyAddress = async () => {
  if (!railgunAddress) return;
  try {
    await navigator.clipboard.writeText(railgunAddress);
    toast.success('Address copied!');
  } catch (err) {
    toast.error('Failed to copy');
  }
};
```

2. Update connected state UI to include copy button:
```jsx
{isConnected ? (
  <div className="flex items-center gap-2">
    <div className="flex items-center gap-1 text-xs text-green-700 bg-green-50 px-2 py-1 rounded">
      <span>Railgun:</span>
      <span className="font-mono">
        {railgunAddress ? `${railgunAddress.slice(0, 8)}...${railgunAddress.slice(-6)}` : 'Connected'}
      </span>
      <button
        onClick={copyAddress}
        className="ml-1 p-0.5 hover:bg-green-100 rounded"
        title="Copy full address"
      >
        <svg xmlns="http://www.w3.org/2000/svg" className="h-3.5 w-3.5" fill="none" viewBox="0 0 24 24" stroke="currentColor">
          <path strokeLinecap="round" strokeLinejoin="round" strokeWidth={2} d="M8 16H6a2 2 0 01-2-2V6a2 2 0 012-2h8a2 2 0 012 2v2m-6 12h8a2 2 0 002-2v-8a2 2 0 00-2-2h-8a2 2 0 00-2 2v8a2 2 0 002 2z" />
        </svg>
      </button>
    </div>
    <Button
      onClick={handleDisconnect}
      variant="outline"
      size="sm"
      className="text-xs border-red-200 text-red-700 hover:bg-red-50"
    >
      Disconnect
    </Button>
  </div>
) : (
  ...
)}
```

3. Improve connecting state with proper spinner (replace emoji):
```jsx
<Button
  onClick={handleConnectRailgun}
  disabled={isConnecting}
  variant="outline"
  className="bg-purple-50 border-purple-200 text-purple-700 hover:bg-purple-100"
>
  {isConnecting ? (
    <span className="flex items-center gap-2">
      <svg className="animate-spin h-4 w-4" xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24">
        <circle className="opacity-25" cx="12" cy="12" r="10" stroke="currentColor" strokeWidth="4"></circle>
        <path className="opacity-75" fill="currentColor" d="M4 12a8 8 0 018-8V0C5.373 0 0 5.373 0 12h4zm2 5.291A7.962 7.962 0 014 12H0c0 3.042 1.135 5.824 3 7.938l3-2.647z"></path>
      </svg>
      Connecting...
    </span>
  ) : (
    'Connect Railgun'
  )}
</Button>
```

4. Remove emojis from toast messages to match CONTEXT.md preference:
```javascript
// Change:
toast.success('Railgun wallet connected successfully!');
// Instead of:
toast.success('‚úÖ Railgun wallet connected successfully!');
```

5. Simplify error display (hide technical details):
```javascript
// In catch block:
const userMessage = error.message.includes('rejected')
  ? 'Connection cancelled'
  : 'Failed to connect. Please try again.';
toast.error(userMessage);
```
  </action>
  <verify>
1. `grep "navigator.clipboard.writeText" frontend/src/components/railgun/RailgunConnectionButton.jsx` shows copy functionality
2. `grep "animate-spin" frontend/src/components/railgun/RailgunConnectionButton.jsx` shows spinner
3. `grep -c "‚úÖ\|üîê\|üîå\|üîí" frontend/src/components/railgun/RailgunConnectionButton.jsx` should be 0 or minimal (emojis removed from user-facing text)
  </verify>
  <done>RailgunConnectionButton has copy button, spinner, and clean error messages</done>
</task>

<task type="checkpoint:human-verify" gate="blocking">
  <what-built>
Complete wallet connection flow with:
- Encrypted mnemonic storage (Plan 01)
- Fixed signing message for deterministic keys
- Copy button for Railgun address
- Spinner during connection
- Silent retry on SDK failures
- User-friendly error messages
  </what-built>
  <how-to-verify>
1. Start the frontend: `cd frontend && npm start`
2. Open browser to http://localhost:3000
3. Connect MetaMask (if not already)
4. Click "Connect Railgun" button
5. Verify:
   - Spinner shows during connection
   - MetaMask prompts for signature (message should be "Railgun Wallet Encryption Key")
   - After signing, Railgun address displays as "Railgun: 0zk1234...abcd"
   - Copy button appears next to address
   - Click copy button - toast shows "Address copied!"
   - Paste somewhere to verify full address was copied
6. Refresh the page
7. Verify:
   - Connection restores automatically (no re-signing needed until tab closes)
   - Same Railgun address shows
8. Click "Disconnect"
9. Click "Connect Railgun" again
10. Verify:
    - MetaMask prompts for signature again
    - SAME Railgun address appears (wallet restored from encrypted mnemonic)
  </how-to-verify>
  <resume-signal>Type "approved" if all checks pass, or describe issues found</resume-signal>
</task>

</tasks>

<verification>
After all tasks complete:

1. **Retry logic in place:**
   - `grep "withRetry" frontend/src/lib/railgun-clean/connection.js`
   - Shows retry wrapper function and usage

2. **Copy button working:**
   - `grep "navigator.clipboard" frontend/src/components/railgun/RailgunConnectionButton.jsx`
   - Shows clipboard API usage

3. **Spinner visible:**
   - `grep "animate-spin" frontend/src/components/railgun/RailgunConnectionButton.jsx`
   - Shows CSS animation class

4. **Clean UI (no emojis in user text):**
   - Visual inspection of connected state
</verification>

<success_criteria>
- Copy button copies full Railgun address to clipboard
- Spinner shows during connection (not emoji)
- SDK initialization retries 3 times silently before error
- Error messages are user-friendly, no technical details
- Full connection flow verified by human (checkpoint)
</success_criteria>

<output>
After completion, create `.planning/phases/02-wallet-connection/02-02-SUMMARY.md`
</output>
