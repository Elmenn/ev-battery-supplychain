---
phase: 04-weth-shielding
plan: 01
type: execute
wave: 1
depends_on: []
files_modified:
  - frontend/src/lib/railgun-clean/shield.js
  - frontend/src/components/railgun/PrivateFundsDrawer.jsx
autonomous: true

must_haves:
  truths:
    - "User can shield WETH and see transaction succeed"
    - "User sees side-by-side public and private WETH balances"
    - "User sees toast notification with Etherscan link on successful shield"
    - "User sees spinner with status text during shield operation"
    - "Private balance updates after shield transaction confirms"
  artifacts:
    - path: "frontend/src/lib/railgun-clean/shield.js"
      provides: "Working shieldWETH using TXIDVersion enum"
      contains: "TXIDVersion.V2_PoseidonMerkle"
    - path: "frontend/src/components/railgun/PrivateFundsDrawer.jsx"
      provides: "Side-by-side balance UI with Etherscan toast"
      contains: "sepolia.etherscan.io/tx"
  key_links:
    - from: "shield.js"
      to: "@railgun-community/shared-models"
      via: "TXIDVersion enum import"
      pattern: "import.*TXIDVersion.*from.*shared-models"
    - from: "PrivateFundsDrawer.jsx"
      to: "shield.js shieldWETH"
      via: "function call with signer"
      pattern: "shieldWETH\\(shieldAmt, signer\\)"
---

<objective>
Fix WETH shielding to work correctly with the Railgun SDK and update the UI to show side-by-side public/private balances with proper transaction feedback.

Purpose: Enable users to move WETH from their public wallet into Railgun's private balance, with clear visibility of both balances and confirmation via Etherscan link.

Output: Working shield flow where user can shield WETH, see spinner during operation, get toast with Etherscan link on success, and see updated private balance.
</objective>

<execution_context>
@~/.claude/get-shit-done/workflows/execute-plan.md
@~/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/04-weth-shielding/04-CONTEXT.md
@.planning/phases/04-weth-shielding/04-RESEARCH.md

# Key source files
@frontend/src/lib/railgun-clean/shield.js
@frontend/src/components/railgun/PrivateFundsDrawer.jsx
@frontend/src/lib/railgun-client-browser.js
@frontend/src/helpers/format.js
</context>

<tasks>

<task type="auto">
  <name>Task 1: Fix shield.js to use TXIDVersion enum</name>
  <files>frontend/src/lib/railgun-clean/shield.js</files>
  <action>
Fix the SDK type usage in shield.js:

1. Add TXIDVersion import from @railgun-community/shared-models:
   ```javascript
   import { TXIDVersion } from '@railgun-community/shared-models';
   ```

2. Replace ALL string literals with enum values:
   - Change `'V2_PoseidonMerkle'` to `TXIDVersion.V2_PoseidonMerkle`
   - Change `'V3_PoseidonMerkle'` to `TXIDVersion.V3_PoseidonMerkle`

   Locations to fix:
   - estimateShieldWETH: lines ~115, ~136 (gasEstimateForShield calls)
   - shieldWETH: lines ~306, ~315 (populateShield calls)

3. Keep the V2 -> V3 fallback pattern (try V2 first, catch and try V3).

4. Remove the window.railgun fallback attempt (lines 161-183) - it's dead code that never works.

5. Simplify error messages - remove the "SDK version mismatch" suggestions since we're fixing the root cause.

Do NOT change:
- The chain object extraction (already correct)
- The ERC-20 approval flow (already correct)
- The getShieldPrivateKey helper (already correct)
- The refreshBalances call at the end (already correct)
  </action>
  <verify>
Run `npm run build` in frontend directory - should compile without errors.
Grep for string literals: `grep -n "V2_PoseidonMerkle\|V3_PoseidonMerkle" frontend/src/lib/railgun-clean/shield.js` should show TXIDVersion.* not bare strings.
  </verify>
  <done>
shield.js imports TXIDVersion enum and uses TXIDVersion.V2_PoseidonMerkle/V3_PoseidonMerkle instead of string literals. Build passes.
  </done>
</task>

<task type="auto">
  <name>Task 2: Update PrivateFundsDrawer with side-by-side balances and Etherscan toast</name>
  <files>frontend/src/components/railgun/PrivateFundsDrawer.jsx</files>
  <action>
Update the UI per CONTEXT.md decisions:

1. BALANCE DISPLAY - Replace the separate EOA/Railgun sections with side-by-side layout:
   ```jsx
   {/* Side-by-side WETH Balances */}
   <div className="flex gap-4 mb-4">
     {/* Public WETH */}
     <div className="flex-1 p-3 bg-gray-50 rounded-lg">
       <span className="text-xs text-gray-500 uppercase tracking-wide">Public</span>
       <p className="font-mono text-lg">
         {busy ? (
           <span className="animate-pulse">...</span>
         ) : (
           `${balances?.eoa?.weth ?? '0'} WETH`
         )}
       </p>
     </div>

     {/* Private WETH */}
     <div className="flex-1 p-3 bg-purple-50 rounded-lg">
       <span className="text-xs text-purple-500 uppercase tracking-wide">Private</span>
       <p className="font-mono text-lg text-purple-700">
         {busy ? (
           <span className="animate-pulse">...</span>
         ) : (
           `${fmt18(balances?.railgun?.weth)} WETH`
         )}
       </p>
       {balances?.railgun?.pendingWeth > 0n && (
         <p className="text-xs text-orange-500">
           +{fmt18(balances?.railgun?.pendingWeth)} pending
         </p>
       )}
     </div>
   </div>
   ```

2. Keep the ETH balance row separately below (user still needs to see ETH for wrapping):
   ```jsx
   <div className="text-sm text-gray-600 mb-4">
     ETH Balance: {balances?.eoa?.eth ?? '0'} ETH
   </div>
   ```

3. SHIELD BUTTON - Update to show "Shielding WETH..." with spinner:
   ```jsx
   <Button ...>
     {shielding ? (
       <>
         <svg className="animate-spin -ml-1 mr-2 h-4 w-4" xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24">
           <circle className="opacity-25" cx="12" cy="12" r="10" stroke="currentColor" strokeWidth="4"></circle>
           <path className="opacity-75" fill="currentColor" d="M4 12a8 8 0 018-8V0C5.373 0 0 5.373 0 12h4zm2 5.291A7.962 7.962 0 014 12H0c0 3.042 1.135 5.824 3 7.938l3-2.647z"></path>
         </svg>
         Shielding WETH...
       </>
     ) : (
       'Shield WETH'
     )}
   </Button>
   ```

4. TOAST WITH ETHERSCAN LINK - Update onShield success handler:
   ```jsx
   if (result.success) {
     const explorerUrl = `https://sepolia.etherscan.io/tx/${result.txHash}`;
     toast.success(
       <div>
         <p>WETH shielded successfully!</p>
         <a
           href={explorerUrl}
           target="_blank"
           rel="noreferrer"
           className="text-blue-500 underline text-sm"
         >
           View on Etherscan
         </a>
       </div>,
       { duration: 5000 }
     );
     await refreshBalances();
   }
   ```

5. Remove the emoji prefixes from buttons (per codebase conventions - no emojis in UI).

Do NOT change:
- The wrap ETH section (working from Phase 3)
- The input fields and their handlers
- The refreshBalances function logic
- The modal structure/layout
  </action>
  <verify>
Run `npm run build` in frontend directory - should compile without errors.
Visual check: Open app, navigate to PrivateFundsDrawer - should show side-by-side "Public | Private" WETH balances.
  </verify>
  <done>
PrivateFundsDrawer shows side-by-side WETH balances (Public: X WETH | Private: Y WETH), shield button shows spinner with "Shielding WETH..." during operation, success toast includes clickable Etherscan link.
  </done>
</task>

<task type="checkpoint:human-verify" gate="blocking">
  <what-built>
Complete WETH shielding flow with fixed SDK calls and updated UI showing side-by-side balances.
  </what-built>
  <how-to-verify>
1. Start the app: `cd frontend && npm start`
2. Connect MetaMask (Sepolia network)
3. Open the Private Funds drawer
4. Verify: Side-by-side layout shows "Public: X WETH | Private: Y WETH"
5. If you have WETH, enter 0.001 in shield amount
6. Click "Shield WETH" button
7. Verify: Button shows spinner with "Shielding WETH..." text
8. Approve MetaMask transactions (approval + shield)
9. Verify: Toast appears with "WETH shielded successfully!" and clickable "View on Etherscan" link
10. Click the Etherscan link - should open transaction details
11. Verify: Private balance updates after a moment (may show as "pending" first)
  </how-to-verify>
  <resume-signal>Type "approved" to confirm shielding works, or describe any issues encountered.</resume-signal>
</task>

</tasks>

<verification>
Phase verification steps:
1. Build passes: `cd frontend && npm run build`
2. No TypeScript/lint errors in modified files
3. Shield transaction completes on Sepolia testnet
4. Private balance reflects shielded amount (immediately as pending, later as spendable)
5. Etherscan link in toast navigates to correct transaction
</verification>

<success_criteria>
- shieldWETH() uses TXIDVersion enum (not string literals)
- UI shows side-by-side Public/Private WETH balances
- Shield button shows spinner with "Shielding WETH..." during operation
- Success toast includes clickable Etherscan link
- Private balance updates after shield confirms
- Human verification passed
</success_criteria>

<output>
After completion, create `.planning/phases/04-weth-shielding/04-01-SUMMARY.md`
</output>
