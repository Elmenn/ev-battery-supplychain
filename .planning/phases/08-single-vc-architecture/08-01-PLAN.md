---
phase: 08-single-vc-architecture
plan: 01
type: execute
wave: 1
depends_on: []
files_modified:
  - frontend/src/utils/vcBuilder.mjs
  - frontend/src/utils/vcBuilder.js
autonomous: true

must_haves:
  truths:
    - "createListingVC produces a valid W3C-ish VC with null payment and delivery sections"
    - "appendPaymentProof fills the payment section and sets previousVersion without mutating the original"
    - "appendDeliveryProof fills the delivery section and sets previousVersion without mutating the original"
    - "hashVcPayload and freezeVcJson still work (backward compatible)"
    - "vcBuilder.js CJS duplicate is deleted"
    - "Existing imports of buildStage2VC, buildStage3VC, freezeVcJson from vcBuilder.mjs still compile (deprecated stubs)"
  artifacts:
    - path: "frontend/src/utils/vcBuilder.mjs"
      provides: "createListingVC, appendPaymentProof, appendDeliveryProof, hashVcPayload, freezeVcJson, buildStage2VC (deprecated stub), buildStage3VC (deprecated stub)"
      exports: ["createListingVC", "appendPaymentProof", "appendDeliveryProof", "hashVcPayload", "freezeVcJson", "buildStage2VC", "buildStage3VC"]
    - path: "frontend/src/utils/vcBuilder.js"
      provides: "DELETED"
  key_links:
    - from: "frontend/src/utils/vcBuilder.mjs"
      to: "ethers"
      via: "keccak256 import"
      pattern: "import.*keccak256.*from.*ethers"
    - from: "frontend/src/utils/vcBuilder.mjs"
      to: "json-canonicalize"
      via: "canonicalize import"
      pattern: "import.*canonicalize.*from.*json-canonicalize"
---

<objective>
Rewrite vcBuilder.mjs to replace the 3-stage VC pattern (buildStage0VC, buildStage2VC, buildStage3VC) with an append-only single-document pattern (createListingVC, appendPaymentProof, appendDeliveryProof). Delete the CJS duplicate vcBuilder.js. Add deprecated stub exports for old function names so existing imports in App.js, ProductDetail.jsx, and test files still compile.

Purpose: The single append-only VC is the core data structure that all other Phase 8 work (signing, verification, IPFS fetch) depends on. This must land first.

Output: Rewritten vcBuilder.mjs with new exports + deprecated stubs, deleted vcBuilder.js
</objective>

<execution_context>
@~/.claude/get-shit-done/workflows/execute-plan.md
@~/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/08-single-vc-architecture/08-RESEARCH.md
@frontend/src/utils/vcBuilder.mjs
@frontend/src/utils/vcBuilder.js
@frontend/src/utils/commitmentUtils.js
</context>

<tasks>

<task type="auto">
  <name>Task 1: Rewrite vcBuilder.mjs with append-only VC functions and deprecated stubs</name>
  <files>frontend/src/utils/vcBuilder.mjs</files>
  <action>
Rewrite `vcBuilder.mjs` completely. Remove ALL old stage-based function IMPLEMENTATIONS (buildStage0VC, buildStage2VC, buildStage3VC, buildStage3VCWithIdentityLinkage) and ALL identity linkage functions (generateIdentityLinkageProof, verifyIdentityLinkageProof, hasIdentityLinkageProof, extractIdentityLinkageProof, validateVCIdentityLinkage, generateLinkageZKP, verifyLinkageZKP). These are dead code with mock implementations.

KEEP and preserve exactly:
- `inferChainId()` helper (used throughout)
- `hashVcPayload(vc)` function (uses keccak256 + canonicalize)
- `freezeVcJson(vc)` function (uses canonicalize)

ADD these new exported functions:

1. `createListingVC({ sellerAddr, productName, batch, quantity, productContract, productId, chainId, priceCommitment, certificateCredential, componentCredentials })`:
   - Returns a W3C-ish VC object with schemaVersion "2.0"
   - Structure must match the schema in 08-RESEARCH.md Pattern 1 exactly:
     - `@context`: ["https://www.w3.org/2018/credentials/v1"]
     - `id`: urn:uuid:<generated via uuid()>
     - `type`: ["VerifiableCredential", "SupplyChainCredential"]
     - `schemaVersion`: "2.0"
     - `issuer`: { id: "did:ethr:<chainId>:<sellerAddr>", name: "Seller" }
     - `holder`: { id: "did:ethr:<chainId>:0x0000000000000000000000000000000000000000", name: "T.B.D." } (FCFS buyer unknown at listing)
     - `issuanceDate`: ISO timestamp
     - `credentialSubject`: contains productName, batch, quantity, productContract, productId, chainId, priceCommitment object (with protocol "bulletproofs-pedersen", version "1.0", encoding "hex", spread the rest from input), listing section (timestamp, certificateCredential, componentCredentials), payment: null, delivery: null
     - `previousVersion`: null
     - `proof`: [] (empty, seller signs separately)
   - Use `inferChainId()` as fallback when chainId not provided
   - Use ethers ZeroAddress for the unknown buyer holder DID

2. `appendPaymentProof(vc, { buyerAddr, memoHash, railgunTxRef, txHashCommitment, previousVersionCid })`:
   - Deep clones input VC (JSON parse/stringify)
   - Updates `holder` to buyer DID
   - Fills `credentialSubject.payment` with: timestamp, buyerAddress (as DID), memoHash, railgunTxRef, and optional txHashCommitment
   - Sets `previousVersion` to `previousVersionCid`
   - Does NOT modify proof array (buyer signs separately)
   - Returns the new VC object (does NOT mutate input)

3. `appendDeliveryProof(vc, { transporterAddr, previousVersionCid })`:
   - Deep clones input VC
   - Fills `credentialSubject.delivery` with: timestamp, transporterAddress (as DID), vcHashVerified: true
   - Sets `previousVersion` to `previousVersionCid`
   - Does NOT modify proof array
   - Returns the new VC object (does NOT mutate input)

Import ethers for ZeroAddress: `import { keccak256, ZeroAddress } from "ethers";`

ADD deprecated stub exports for backward compatibility. Three files import old functions:
- `frontend/src/App.js` imports `buildStage3VC`
- `frontend/src/components/marketplace/ProductDetail.jsx` imports `buildStage2VC`, `buildStage3VC`, `freezeVcJson`
- `frontend/src/utils/__tests__/test_tx_hash_commitment.js` imports `buildStage3VC`, `freezeVcJson`

`freezeVcJson` is already preserved (see above). For the removed functions, add these deprecated stub exports at the bottom of the file:

```javascript
// ---------- DEPRECATED STUBS ----------
// These functions are removed in v2.0 (single-VC architecture).
// Stubs kept so existing imports compile. Phase 9 will update call sites.

/** @deprecated Use createListingVC + appendPaymentProof instead */
export function buildStage2VC() {
  throw new Error(
    "buildStage2VC removed in v2.0 -- use appendPaymentProof instead. See Phase 8 migration."
  );
}

/** @deprecated Use createListingVC + appendDeliveryProof instead */
export function buildStage3VC() {
  throw new Error(
    "buildStage3VC removed in v2.0 -- use appendDeliveryProof instead. See Phase 8 migration."
  );
}
```

Do NOT add a stub for `buildStage0VC` (nothing imports it).

The file should be clean and focused. No mock functions, no dead code, no commented-out blocks (except the deprecated stubs section which is clearly marked).
  </action>
  <verify>
Run `node -e "import('./frontend/src/utils/vcBuilder.mjs').then(m => { console.log(Object.keys(m)); const vc = m.createListingVC({ sellerAddr: '0x1234567890123456789012345678901234567890', productName: 'Test', batch: 'B1', quantity: 1, productContract: '0x0000000000000000000000000000000000000001', productId: '1', chainId: '1337', priceCommitment: { commitment: '0xabc', proof: '0xdef', verified: true, bindingTag: '0x123' }, certificateCredential: { name: 'cert', cid: 'QmTest' }, componentCredentials: [] }); console.log(JSON.stringify(vc, null, 2)); const paid = m.appendPaymentProof(vc, { buyerAddr: '0x9876543210987654321098765432109876543210', memoHash: '0xmemo', railgunTxRef: '0xref', previousVersionCid: 'QmVersion1' }); console.log('payment filled:', paid.credentialSubject.payment !== null); console.log('original unchanged:', vc.credentialSubject.payment === null); console.log('previousVersion:', paid.previousVersion); try { m.buildStage3VC(); } catch(e) { console.log('deprecated stub works:', e.message.includes('removed in v2.0')); } })"` from the project root. Should show all exports (including buildStage2VC, buildStage3VC stubs), a valid VC structure with null payment/delivery, confirm immutability, and confirm deprecated stubs throw descriptive errors.
  </verify>
  <done>
  - createListingVC returns W3C-ish VC with schemaVersion "2.0", null payment/delivery, empty proof array
  - appendPaymentProof fills payment section, sets previousVersion, does not mutate input
  - appendDeliveryProof fills delivery section, sets previousVersion, does not mutate input
  - hashVcPayload and freezeVcJson still exported and functional
  - buildStage2VC and buildStage3VC exported as deprecated stubs that throw descriptive errors
  - Existing imports in App.js, ProductDetail.jsx, and test files still compile
  - No old stage function implementations remain
  - No identity linkage functions remain
  </done>
</task>

<task type="auto">
  <name>Task 2: Delete vcBuilder.js CJS duplicate</name>
  <files>frontend/src/utils/vcBuilder.js</files>
  <action>
Delete `frontend/src/utils/vcBuilder.js` entirely. This is a CommonJS duplicate of vcBuilder.mjs with `module.exports` syntax. It contains the same old stage-based functions and is not imported by the React app (the React app uses .mjs imports).

After deletion, search for any remaining imports of `vcBuilder.js` (not `.mjs`) in the codebase:
- `grep -r "vcBuilder.js" frontend/src/` or similar
- `grep -r "from.*vcBuilder['\"]" frontend/src/` (without .mjs extension)
- If any imports reference `vcBuilder` without `.mjs`, note them for Phase 9 cleanup but do NOT modify UI components (Phase 8 scope is utilities only)

The only file that might import from vcBuilder.js is `createProduct.js` (an Express route, not part of the React app). If found, leave a TODO comment in the SUMMARY noting it needs updating.
  </action>
  <verify>
Confirm `frontend/src/utils/vcBuilder.js` no longer exists: `ls frontend/src/utils/vcBuilder.js` should fail. Run `grep -r "vcBuilder" frontend/src/ --include="*.js" --include="*.jsx" --include="*.mjs" | grep -v node_modules | grep -v vcBuilder.mjs` to check for any dangling imports.
  </verify>
  <done>
  - vcBuilder.js is deleted from the filesystem
  - No React app component imports from vcBuilder.js (only .mjs)
  - Any non-React imports noted in SUMMARY for future cleanup
  </done>
</task>

</tasks>

<verification>
- `frontend/src/utils/vcBuilder.mjs` exports exactly: createListingVC, appendPaymentProof, appendDeliveryProof, hashVcPayload, freezeVcJson, buildStage2VC (stub), buildStage3VC (stub)
- `frontend/src/utils/vcBuilder.js` does not exist
- createListingVC output has `schemaVersion: "2.0"`, `previousVersion: null`, `proof: []`, `credentialSubject.payment: null`, `credentialSubject.delivery: null`
- appendPaymentProof returns new object without mutating input, fills payment section, sets previousVersion
- appendDeliveryProof returns new object without mutating input, fills delivery section, sets previousVersion
- buildStage2VC() throws Error with message containing "removed in v2.0"
- buildStage3VC() throws Error with message containing "removed in v2.0"
- No old function implementations remain: buildStage0VC, buildStage2VC (real impl), buildStage3VC (real impl), generateIdentityLinkageProof
- Existing imports in App.js, ProductDetail.jsx, test_tx_hash_commitment.js still resolve without module errors
</verification>

<success_criteria>
Single append-only VC builder with 3 lifecycle functions (create, append payment, append delivery) replaces the old 3-stage pattern. CJS duplicate deleted. Utility functions (hash, freeze) preserved. Deprecated stubs keep existing imports compilable with descriptive runtime errors pointing to new API.
</success_criteria>

<output>
After completion, create `.planning/phases/08-single-vc-architecture/08-01-SUMMARY.md`
</output>
