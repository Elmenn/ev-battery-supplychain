---
phase: 10-cleanup-e2e
plan: 03
type: execute
wave: 2
depends_on: ["10-01"]
files_modified:
  - test/E2E_FullLifecycle.test.js
  - docs/GAS_COMPARISON.md
autonomous: true

must_haves:
  truths:
    - "E2E test script exercises the complete contract lifecycle (8 steps)"
    - "E2E test passes on Ganache"
    - "Gas usage is captured for every operation"
    - "Gas comparison report documents old vs new contract operations"
    - "Operation mapping explains flow differences between old and new"
  artifacts:
    - path: "test/E2E_FullLifecycle.test.js"
      provides: "Full lifecycle E2E test with gas reporting"
      contains: "GAS REPORT"
    - path: "docs/GAS_COMPARISON.md"
      provides: "Gas comparison report for thesis"
      contains: "Old Contract"
  key_links:
    - from: "test/E2E_FullLifecycle.test.js"
      to: "contracts/ProductEscrow_Initializer.sol"
      via: "artifacts.require"
      pattern: "ProductEscrow_Initializer"
    - from: "test/E2E_FullLifecycle.test.js"
      to: "contracts/ProductFactory.sol"
      via: "artifacts.require"
      pattern: "ProductFactory"
---

<objective>
Create an E2E test script that exercises the full contract lifecycle on Ganache with gas measurement, then produce a gas comparison report (old vs new contract) for the thesis.

Purpose: Demonstrate the complete redesigned flow works end-to-end and provide gas data for thesis evaluation.
Output: Passing E2E test with gas report output, and docs/GAS_COMPARISON.md with operation-level comparison.
</objective>

<execution_context>
@~/.claude/get-shit-done/workflows/execute-plan.md
@~/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/10-cleanup-e2e/10-CONTEXT.md
@.planning/phases/10-cleanup-e2e/10-RESEARCH.md
@contracts/ProductEscrow_Initializer.sol
@contracts/ProductFactory.sol
@test/EscrowRedesign.test.js
</context>

<tasks>

<task type="auto">
  <name>Task 1: Create E2E full lifecycle test with gas measurement</name>
  <files>test/E2E_FullLifecycle.test.js</files>
  <action>
    Create `test/E2E_FullLifecycle.test.js` following the proven pattern from EscrowRedesign.test.js.

    The test should exercise the COMPLETE lifecycle in a single `it()` block, collecting gas data at each step:

    **Setup:**
    ```javascript
    const ProductEscrow_Initializer = artifacts.require("ProductEscrow_Initializer");
    const ProductFactory = artifacts.require("ProductFactory");
    const { toWei, randomHex, soliditySha3 } = web3.utils;
    ```

    **Accounts mapping:**
    - accounts[0] = deployer
    - accounts[1] = seller
    - accounts[2] = buyer
    - accounts[3] = transporter

    **Constants:**
    - BOND = toWei("0.01", "ether")
    - FEE = toWei("0.005", "ether")
    - VCID = "ipfs://QmE2ETestVcCid"

    **8-step lifecycle (each step captures tx.receipt.gasUsed):**

    1. **Deploy:** Deploy implementation + factory, call setBondAmount
    2. **Create Product:** Seller calls factory.createProduct with bond value. Extract clone address from ProductCreated event.
    3. **Record Payment:** Buyer calls recordPrivatePayment(1, memoHash, txRef) on clone
    4. **Confirm Order:** Seller calls confirmOrder(VCID) on clone
    5. **Transporter Bid:** Transporter calls createTransporter(FEE, {value: BOND}) on clone
    6. **Select Transporter:** Seller calls setTransporter(transporter, {value: FEE}) on clone
    7. **Confirm Delivery:** Transporter calls confirmDelivery(vcHash) where vcHash = soliditySha3({type: "string", value: VCID})
    8. **Verify Final State:** Assert phase == 4 (Delivered), assert delivered == true, check balance changes

    **Gas report output:** After all steps, print a formatted table to console:
    ```
    ========== GAS REPORT (New Contract) ==========
      setBondAmount:        XXXXX gas
      createProduct:        XXXXX gas
      recordPrivatePayment: XXXXX gas
      confirmOrder:         XXXXX gas
      createTransporter:    XXXXX gas
      setTransporter:       XXXXX gas
      confirmDelivery:      XXXXX gas
      TOTAL LIFECYCLE:      XXXXX gas
    ================================================
    ```

    **Additional assertions:**
    - After delivery, seller bond is returned (check balance increased by BOND - gas)
    - After delivery, transporter bond is returned + fee paid
    - Phase transitions are correct at each step

    Use `contract("E2E Full Lifecycle", accounts => { ... })` wrapper (Truffle convention).
  </action>
  <verify>
    Run: `npx truffle test test/E2E_FullLifecycle.test.js --network development` -- should pass with gas report printed.
    Output should show gas values for all 7 operations plus total.
  </verify>
  <done>E2E test passes on Ganache. All 8 lifecycle steps complete. Gas data captured and printed for every operation.</done>
</task>

<task type="auto">
  <name>Task 2: Create gas comparison report</name>
  <files>docs/GAS_COMPARISON.md</files>
  <action>
    Create `docs/GAS_COMPARISON.md` with a comparison of old vs new contract gas usage.

    **For new contract gas numbers:** Use the actual output from Task 1's E2E test run.

    **For old contract gas numbers:** Retrieve the old contract from git history and measure gas. Strategy:
    1. Find the last commit before Phase 7 that has the old contract: `git log --oneline contracts/ProductEscrow_Initializer.sol` to find the Phase 7 rewrite commit, then use the parent commit.
    2. Use `git show <parent-commit>:contracts/ProductEscrow_Initializer.sol` to extract old contract source.
    3. Create a temporary test file that deploys the OLD contract and measures gas for equivalent operations.
    4. Run it, capture gas numbers, then delete the temp file.

    If retrieving old contract proves too complex (different compiler settings, missing dependencies), use "N/A - different interface" for old values and focus on documenting the new contract's gas profile with an explanation of WHY direct comparison is not possible (fundamentally different flow).

    **Report structure:**

    ```markdown
    # Gas Comparison: Old vs New ProductEscrow Contract

    ## Methodology
    - Environment: Ganache (local)
    - Compiler: solc 0.8.21 (optimizer on, 200 runs)
    - Gas price reference: 30 gwei
    - All measurements from actual transaction receipts

    ## Operation Mapping

    | Step | Old Contract | New Contract | Notes |
    |------|-------------|-------------|-------|
    | Create Product | createProduct(name, commitment, price) | createProduct(name, commitment) + {value: bond} | New includes bond deposit |
    | Purchase | purchasePublic({value: price}) | recordPrivatePayment(id, memo, txRef) | New has no ETH transfer (Railgun off-chain) |
    | Confirm Order | confirmOrderWithCommitment(cid, commitment) | confirmOrder(cid) | Simplified |
    | Transporter Setup | createTransporter(fee) + securityDeposit({value}) | createTransporter(fee, {value: bond}) | Combined into single tx |
    | Select Transporter | setTransporter(addr, {value: fee}) | setTransporter(addr, {value: fee}) | Same |
    | Confirm Delivery | revealAndConfirmDelivery(value, blinding, cid) | confirmDelivery(hash) | Transporter calls, hash-only |

    ## Gas Results

    | Operation | Old Contract (gas) | New Contract (gas) | Delta | % Change |
    |-----------|-------------------|-------------------|-------|----------|
    | ... | ... | ... | ... | ... |

    ## Analysis
    [2-3 paragraphs interpreting results for thesis]
    ```

    Key analysis points to cover:
    - recordPrivatePayment is cheaper than purchasePublic (no ETH transfer in contract)
    - confirmDelivery is cheaper than revealAndConfirmDelivery (hash vs reveal+verify)
    - Bond mechanism adds cost to createProduct but provides economic security
    - Total lifecycle gas comparison
  </action>
  <verify>
    File exists at docs/GAS_COMPARISON.md.
    Contains actual gas numbers from E2E test run (not placeholders).
    Contains operation mapping table explaining flow differences.
    Contains analysis section suitable for thesis reference.
  </verify>
  <done>Gas comparison report complete with actual measurements, operation mapping, and thesis-ready analysis.</done>
</task>

</tasks>

<verification>
1. `npx truffle test test/E2E_FullLifecycle.test.js --network development` passes
2. Gas report output shows values for all 7 operations
3. docs/GAS_COMPARISON.md contains actual gas data (not placeholders)
4. Operation mapping clearly explains old vs new flow differences
5. Analysis section is suitable for thesis reference
</verification>

<success_criteria>
- E2E test exercises complete 8-step lifecycle on Ganache
- All operations pass with gas data captured
- Gas comparison report has real numbers and clear methodology
- Report is thesis-ready with proper operation mapping and analysis
</success_criteria>

<output>
After completion, create `.planning/phases/10-cleanup-e2e/10-03-SUMMARY.md`
</output>
