---
phase: 07-smart-contract-redesign
plan: 01
type: execute
wave: 1
depends_on: []
files_modified:
  - contracts/ProductEscrow_Initializer.sol
  - contracts/ProductFactory.sol
autonomous: true

must_haves:
  truths:
    - "ProductEscrow_Initializer compiles with Solidity 0.8.21"
    - "ProductFactory compiles and can create clones with bond forwarding"
    - "No public purchase functions exist in the contract"
    - "Seller bond, transporter bond, and delivery fee are tracked separately"
    - "confirmDelivery is callable only by transporter with correct hash"
    - "All three timeout functions distribute bonds correctly"
  artifacts:
    - path: "contracts/ProductEscrow_Initializer.sol"
      provides: "Redesigned escrow with private-only purchases, bond staking, transporter delivery"
      contains: "function confirmDelivery"
    - path: "contracts/ProductFactory.sol"
      provides: "Factory with bondAmount config and payable createProduct"
      contains: "function setBondAmount"
  key_links:
    - from: "contracts/ProductFactory.sol"
      to: "contracts/ProductEscrow_Initializer.sol"
      via: "clone.initialize{value: msg.value}"
      pattern: "initialize\\{value"
---

<objective>
Rewrite ProductEscrow_Initializer.sol for the private-only escrow flow with seller/transporter bond staking, transporter-confirmed delivery via hash verification, and bytes32 vcHash storage. Update ProductFactory.sol with bond configuration and payable product creation.

Purpose: This is the foundation for the entire escrow redesign. The contract must be correct before any tests, UI, or deployment work.
Output: Two compilable Solidity contracts implementing the new escrow economics.
</objective>

<execution_context>
@~/.claude/get-shit-done/workflows/execute-plan.md
@~/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/07-smart-contract-redesign/07-CONTEXT.md
@.planning/phases/07-smart-contract-redesign/07-RESEARCH.md
@contracts/ProductEscrow_Initializer.sol
@contracts/ProductFactory.sol
@contracts/helpers/MaliciousReentrant.sol
</context>

<tasks>

<task type="auto">
  <name>Task 1: Rewrite ProductEscrow_Initializer.sol</name>
  <files>contracts/ProductEscrow_Initializer.sol</files>
  <action>
  Rewrite the contract from scratch using the current file as reference. The research document (07-RESEARCH.md) contains the complete function-by-function keep/modify/remove map, new function designs with code snippets, storage layout changes, event redesign, and custom error redesign. Use it as the primary specification.

  **Key structural changes:**

  1. **Storage variables:** Remove productPrice, vcCid (string), purchaseMode, publicPriceWei, publicPriceCommitment, commitmentFrozen, publicEnabled, privateEnabled, valueCommitment, valueRangeProof. Add sellerBond (uint256), vcHash (bytes32), bondAmount (uint256), boundTimestamp (uint64 packed with Group 3).

  2. **Phase enum:** Listed, Purchased, OrderConfirmed, Bound, Delivered, Expired (same as current).

  3. **Functions to REMOVE entirely:** setPublicEnabled, setPrivateEnabled, setPublicPrice, setPublicPriceWithCommitment, depositPurchase, purchasePublic, depositPurchasePrivate, _depositPurchase, revealAndConfirmDelivery, _revealAndConfirmDelivery, verifyRevealedValue, _verifyRevealedValue, updateVcCidAfterDelivery, updateVcCid, securityDeposit.

  4. **Functions to KEEP (unchanged or minimal):** computeCommitment (pure helper), pauseByFactory, isStopped, getAllTransporters, receive/fallback (reject ETH).

  5. **Functions to MODIFY:**
     - `initialize(uint256 _id, string memory _name, bytes32 _priceCommitment, address _owner, uint256 _bondAmount, address _factory) external payable` — Remove productPrice param. Add bondAmount. Accept msg.value as sellerBond. Store sellerBond = msg.value. Validate msg.value == _bondAmount.
     - `confirmOrder(string calldata vcCID)` — Compute vcHash = keccak256(bytes(vcCID)), store bytes32, emit CID in event. Set orderConfirmedTimestamp. Phase: Purchased -> OrderConfirmed.
     - `createTransporter(uint _feeInWei) public payable` — Require msg.value == bondAmount (transporter stakes bond). Store in securityDeposits[msg.sender]. Phase must be OrderConfirmed.
     - `setTransporter(address payable _transporter) external payable onlySeller` — Seller deposits transporterFee as msg.value. Set boundTimestamp. Phase: OrderConfirmed -> Bound.
     - `withdrawBid()` — Allow withdrawal in OrderConfirmed OR Expired phases. Return bond from securityDeposits. Only for non-selected transporters.
     - `recordPrivatePayment(bytes32 memoHash, bytes32 railgunTxRef)` — Remove privateEnabled check. Phase must be Listed. Caller becomes buyer. Set purchased=true, purchaseTimestamp. Phase: Listed -> Purchased.

  6. **NEW functions:**
     - `confirmDelivery(bytes32 hash) external nonReentrant` — Only transporter. Phase must be Bound. Verify hash == vcHash (revert HashMismatch if not). Check delivery window (boundTimestamp + 2 days). Phase: Bound -> Delivered. Zero state before transfers. Return sellerBond to seller, return transporterBond + deliveryFee to transporter. Use checks-effects-interactions.
     - `getVcHash() external view returns (bytes32)` — Public getter for transporter to read hash.

  7. **Timeout functions (all permissionless — anyone can call after window expires):**
     - `sellerTimeout()` — Phase: Purchased. Condition: block.timestamp > purchaseTimestamp + 2 days. Slash sellerBond to buyer. Phase -> Expired.
     - `bidTimeout()` — Phase: OrderConfirmed. Condition: block.timestamp > orderConfirmedTimestamp + 2 days. Return sellerBond to seller. Transporter bonds returned individually via withdrawBid(). Phase -> Expired.
     - `deliveryTimeout()` — Phase: Bound. Condition: block.timestamp > boundTimestamp + 2 days. Return sellerBond to seller. Slash transporterBond to seller. Return deliveryFee to seller. Phase -> Expired.

  8. **Events:** Remove all public-mode events (PublicEnabledSet, PrivateEnabledSet, PublicPriceSet, PublicPriceCommitmentSet, PurchasedPublic, PurchaseConfirmedWithCommitment, DeliveryConfirmedWithCommitment, ValueCommitted, ValueRevealed). Add SellerBondDeposited, TransporterBondDeposited, VcHashStored, BondSlashed, BondReturned. Keep PhaseChanged, TransporterCreated, TransporterSelected, BidWithdrawn, PrivatePaymentRecorded, PurchasedPrivate.

  9. **Custom errors:** Remove PublicDisabled, PrivateDisabled, PublicPriceNotSet, InvalidPurchaseMode, CommitmentFrozen. Add BondAlreadyDeposited, BondNotDeposited, HashMismatch, InsufficientBond.

  10. **Security:** Keep ReentrancyGuard on all state-changing functions with ETH transfers. Keep onlySeller, onlyBuyer, onlyTransporter modifiers. Keep whenNotStopped modifier. Use checks-effects-interactions pattern: zero all state BEFORE external calls.

  11. **Constants:** SELLER_WINDOW = 2 days, BID_WINDOW = 2 days, DELIVERY_WINDOW = 2 days, MAX_BIDS = 20.

  **Critical: Price must NEVER appear on-chain.** No productPrice, no msg.value from buyer, no amount in any public function parameter. Only priceCommitment (bytes32 hash).
  </action>
  <verify>Run `npx truffle compile` from the project root. Both contracts must compile without errors or warnings.</verify>
  <done>ProductEscrow_Initializer.sol is rewritten with all public purchase paths removed, bond mechanics implemented, transporter-confirmed delivery via hash verification, bytes32 vcHash storage, and all three timeout functions with correct bond distribution. Contract compiles cleanly.</done>
</task>

<task type="auto">
  <name>Task 2: Update ProductFactory.sol with bond configuration</name>
  <files>contracts/ProductFactory.sol</files>
  <action>
  Update ProductFactory.sol to support the new escrow design. Reference the current file and the research document for exact changes.

  **Changes:**

  1. **New storage variable:** `uint256 public bondAmount` — configurable by factory owner.

  2. **New function:** `setBondAmount(uint256 _amount) external onlyOwner` — Sets the required bond amount. Emit BondAmountUpdated event. Require _amount > 0.

  3. **Modify createProduct:**
     - New signature: `function createProduct(string memory name, bytes32 priceCommitment) external payable whenNotPaused`
     - Remove `uint256 price` parameter entirely (no price on-chain).
     - Make `payable` — seller sends bond as msg.value.
     - Validate `msg.value == bondAmount` (revert if not).
     - After cloning, call `clone.initialize{value: msg.value}(productCount, name, priceCommitment, msg.sender, bondAmount, address(this))` to forward ETH to clone.
     - Update ProductCreated event to emit bondAmount instead of price.

  4. **Update ProductCreated event:**
     ```solidity
     event ProductCreated(
         address indexed product,
         address indexed seller,
         uint256 indexed productId,
         bytes32 priceCommitment,
         uint256 bondAmount
     );
     ```

  5. **Add new event:** `event BondAmountUpdated(uint256 newAmount)`

  6. **Constructor:** Keep existing constructor(address _implementation). After deployment, factory owner must call setBondAmount() to configure. Alternatively, add bondAmount to constructor params if desired.

  7. **Keep unchanged:** setImplementation, pause/unpause, getProduct, getProducts, productCount. The existing Ownable and Pausable patterns remain.

  **Important:** The initialize call must forward msg.value to the clone. Use `{value: msg.value}` syntax on the function call. The clone's initialize function is `payable` and stores the value as sellerBond.
  </action>
  <verify>Run `npx truffle compile` from the project root. Both contracts compile. Inspect the factory's createProduct function to confirm it's payable and forwards msg.value.</verify>
  <done>ProductFactory.sol updated with bondAmount storage, setBondAmount function, payable createProduct that removes price param and forwards seller bond to clone. Both contracts compile together.</done>
</task>

</tasks>

<verification>
1. `npx truffle compile` succeeds with no errors
2. ProductEscrow_Initializer.sol contains no functions named purchasePublic, depositPurchase, setPublicPrice, setPublicEnabled, setPrivateEnabled
3. ProductEscrow_Initializer.sol contains confirmDelivery, sellerTimeout, bidTimeout, deliveryTimeout, getVcHash
4. ProductFactory.sol contains setBondAmount, createProduct is payable with 2 params (name, priceCommitment)
5. No string vcCid storage variable exists — only bytes32 vcHash
6. No productPrice storage variable exists
</verification>

<success_criteria>
Both Solidity contracts compile cleanly with `npx truffle compile`. The escrow implements private-only purchases with bond staking, transporter hash delivery, and three timeout paths. The factory supports configurable bond amounts and forwards seller bond during product creation.
</success_criteria>

<output>
After completion, create `.planning/phases/07-smart-contract-redesign/07-01-SUMMARY.md`
</output>
