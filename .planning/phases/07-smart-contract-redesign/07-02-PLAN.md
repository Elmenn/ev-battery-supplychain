---
phase: 07-smart-contract-redesign
plan: 02
type: execute
wave: 2
depends_on: ["07-01"]
files_modified:
  - test/EscrowRedesign.test.js
  - test/EscrowBonds.test.js
autonomous: true

must_haves:
  truths:
    - "Product creation deposits seller bond correctly"
    - "Private payment recording transitions Listed -> Purchased"
    - "confirmOrder stores vcHash and transitions to OrderConfirmed"
    - "Transporter bidding requires bond stake"
    - "setTransporter transitions to Bound and accepts delivery fee"
    - "confirmDelivery with correct hash releases all bonds and fee"
    - "confirmDelivery with wrong hash reverts"
    - "Only transporter can call confirmDelivery"
    - "Only seller can call confirmOrder and setTransporter"
    - "Reentrancy attacks on bond withdrawal and delivery are blocked"
  artifacts:
    - path: "test/EscrowRedesign.test.js"
      provides: "Full lifecycle and phase transition tests"
      min_lines: 200
    - path: "test/EscrowBonds.test.js"
      provides: "Bond mechanics, access control, reentrancy tests"
      min_lines: 150
  key_links:
    - from: "test/EscrowRedesign.test.js"
      to: "contracts/ProductEscrow_Initializer.sol"
      via: "artifacts.require and contract interaction"
      pattern: "ProductEscrow_Initializer"
---

<objective>
Write comprehensive tests for the redesigned escrow contract covering the full lifecycle (Listed -> Purchased -> OrderConfirmed -> Bound -> Delivered), bond mechanics, access control, hash verification, and reentrancy protection.

Purpose: Verify the contract rewrite works correctly before deployment. These are the core happy-path and security tests.
Output: Two test files covering lifecycle and bond mechanics.
</objective>

<execution_context>
@~/.claude/get-shit-done/workflows/execute-plan.md
@~/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/phases/07-smart-contract-redesign/07-CONTEXT.md
@.planning/phases/07-smart-contract-redesign/07-RESEARCH.md
@.planning/phases/07-smart-contract-redesign/07-01-SUMMARY.md
@contracts/ProductEscrow_Initializer.sol
@contracts/ProductFactory.sol
@contracts/helpers/MaliciousReentrant.sol
@test/SimpleProductEscrow.test.js
</context>

<tasks>

<task type="auto">
  <name>Task 1: Full lifecycle and phase transition tests</name>
  <files>test/EscrowRedesign.test.js</files>
  <action>
  Create test/EscrowRedesign.test.js following the existing test pattern (Truffle, truffle-assertions, web3.utils). Use accounts: [deployer, seller, buyer, transporter, transporter2, anyone].

  **Test helper setup (beforeEach):**
  - Deploy implementation + factory
  - Call factory.setBondAmount(toWei("0.01", "ether"))
  - Create product via factory.createProduct("Test Battery", commitment, { from: seller, value: bondAmount })
  - Get escrow clone address from ProductCreated event

  **Test categories:**

  1. **Product creation with bond:**
     - Clone created with correct id, name, priceCommitment, owner
     - sellerBond stored correctly (check via contract balance or getter)
     - Phase is Listed after creation
     - Revert if msg.value != bondAmount

  2. **recordPrivatePayment (Listed -> Purchased):**
     - Buyer calls recordPrivatePayment(memoHash, railgunTxRef) — caller becomes buyer
     - Phase transitions to Purchased, purchased == true, buyer address set
     - purchaseTimestamp set
     - Revert if phase != Listed
     - Revert if caller is seller (seller != msg.sender)
     - Revert if already purchased
     - Revert if memoHash is zero bytes32
     - Anti-replay: same memoHash cannot be used twice (across products if global)

  3. **confirmOrder (Purchased -> OrderConfirmed):**
     - Seller calls confirmOrder("ipfs://QmSomeVcCid")
     - vcHash == keccak256(bytes("ipfs://QmSomeVcCid")) stored on-chain
     - Phase transitions to OrderConfirmed
     - orderConfirmedTimestamp set
     - Event emits full vcCID string
     - Revert if caller is not seller
     - Revert if phase != Purchased

  4. **createTransporter (bidding in OrderConfirmed):**
     - Transporter bids with fee + bond: createTransporter(feeInWei, { value: bondAmount })
     - Bond stored in securityDeposits mapping
     - isTransporter set, added to transporterAddresses
     - Multiple transporters can bid (test with transporter2)
     - Revert if phase != OrderConfirmed
     - Revert if msg.value != bondAmount
     - Revert if already bid

  5. **setTransporter (OrderConfirmed -> Bound):**
     - Seller selects transporter: setTransporter(transporter, { value: deliveryFee })
     - Phase transitions to Bound
     - boundTimestamp set
     - deliveryFee stored
     - transporter address set
     - Revert if caller is not seller
     - Revert if selected address is not a registered transporter

  6. **confirmDelivery (Bound -> Delivered):**
     - Compute expectedHash = web3.utils.soliditySha3({type: 'string', value: vcCID}) -- or use web3.utils.keccak256(web3.utils.encodePacked(vcCID))
     - **IMPORTANT:** To match Solidity's keccak256(bytes(vcCID)), use `web3.utils.soliditySha3({type: 'string', value: vcCID})` which is equivalent to `keccak256(abi.encodePacked(vcCID))`
     - Transporter calls confirmDelivery(expectedHash)
     - Phase transitions to Delivered
     - Seller receives sellerBond back (check balance change)
     - Transporter receives transporterBond + deliveryFee (check balance change)
     - Contract balance is 0 after delivery
     - Revert if hash != vcHash (HashMismatch)
     - Revert if caller is not transporter
     - Revert if phase != Bound
     - Revert if already delivered

  7. **withdrawBid:**
     - Non-selected transporter can withdraw bond in OrderConfirmed phase
     - Non-selected transporter can withdraw bond in Expired phase
     - Selected transporter cannot withdraw
     - Revert if no bond deposited

  **Use `toWei` for all ETH amounts. Use `web3.utils.randomHex(32)` for commitments and hashes. Use truffle-assertions for event checking and revert testing.**
  </action>
  <verify>Run `npx truffle test test/EscrowRedesign.test.js --network development` (requires Ganache running on port 8545). All tests pass.</verify>
  <done>Full lifecycle test file covers product creation with bond, private payment recording, order confirmation with vcHash, transporter bidding with bond, transporter selection, delivery confirmation with hash verification, and bid withdrawal. All tests pass.</done>
</task>

<task type="auto">
  <name>Task 2: Bond mechanics, access control, and reentrancy tests</name>
  <files>test/EscrowBonds.test.js</files>
  <action>
  Create test/EscrowBonds.test.js for focused bond mechanics testing and security.

  **Test categories:**

  1. **Bond accounting:**
     - After product creation: contract balance == bondAmount (seller bond)
     - After transporter bids: contract balance == sellerBond + transporterBond
     - After setTransporter (with fee): contract balance == sellerBond + transporterBond + deliveryFee
     - After confirmDelivery: contract balance == 0
     - Verify exact balance changes for seller and transporter after delivery (use web3.eth.getBalance before/after, accounting for gas)

  2. **Factory bond configuration:**
     - setBondAmount only callable by owner
     - bondAmount stored correctly
     - createProduct reverts if msg.value != bondAmount
     - createProduct reverts if bondAmount == 0 (or if not yet set)
     - BondAmountUpdated event emitted

  3. **Access control (comprehensive):**
     - confirmOrder: only seller (test with buyer, transporter, anyone -> all revert)
     - setTransporter: only seller
     - confirmDelivery: only transporter (test with seller, buyer, anyone -> all revert)
     - sellerTimeout/bidTimeout/deliveryTimeout: anyone can call (permissionless)
     - recordPrivatePayment: anyone except seller
     - pauseByFactory: only factory address

  4. **Reentrancy protection:**
     - Update MaliciousReentrant.sol if needed to target confirmDelivery (which sends ETH to transporter)
     - Deploy MaliciousReentrant as transporter, attempt reentry on confirmDelivery -> should revert
     - Attempt reentry on withdrawBid -> should revert
     - Attempt reentry on timeout functions -> should revert

  5. **Edge cases:**
     - Double bond deposit (seller creates product, then somehow tries to deposit again -> should be impossible since bond deposited at creation)
     - Transporter bids with wrong bond amount -> revert
     - confirmDelivery after delivery timeout -> revert (phase is Expired, not Bound)
     - receive() and fallback() reject unexpected ETH

  **For reentrancy tests:** If the existing MaliciousReentrant.sol doesn't support the new functions, modify it minimally to add a target function selector for confirmDelivery. The contract should attempt to re-call confirmDelivery when it receives ETH.
  </action>
  <verify>Run `npx truffle test test/EscrowBonds.test.js --network development`. All tests pass.</verify>
  <done>Bond accounting verifies exact ETH flows through the contract lifecycle. Access control tests confirm every function is properly gated. Reentrancy tests confirm ReentrancyGuard blocks re-entry on all ETH-sending functions. All tests pass.</done>
</task>

</tasks>

<verification>
1. `npx truffle test test/EscrowRedesign.test.js` — all tests pass
2. `npx truffle test test/EscrowBonds.test.js` — all tests pass
3. Tests cover all 5 phase transitions (Listed->Purchased->OrderConfirmed->Bound->Delivered)
4. Tests verify hash verification in confirmDelivery (correct hash passes, wrong hash reverts)
5. Tests verify bond distribution on successful delivery (seller gets bond back, transporter gets bond + fee)
6. Reentrancy test exists for confirmDelivery
</verification>

<success_criteria>
Both test files pass against the redesigned contracts on Ganache. The happy path (full lifecycle from product creation to delivery) is tested end-to-end. Bond accounting is verified at each stage. Access control is tested for every externally callable function. Reentrancy protection is confirmed.
</success_criteria>

<output>
After completion, create `.planning/phases/07-smart-contract-redesign/07-02-SUMMARY.md`
</output>
