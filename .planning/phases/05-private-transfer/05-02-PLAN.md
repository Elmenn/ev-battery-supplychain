---
phase: 05-private-transfer
plan: 02
type: execute
wave: 2
depends_on: ["05-01"]
files_modified:
  - frontend/src/lib/railgun-clean/payments.js
  - frontend/src/components/railgun/PrivatePaymentModal.jsx
autonomous: false

must_haves:
  truths:
    - "User sees progress during 20-30 second proof generation"
    - "Payment button disabled during operation with spinner"
    - "Success toast shows transaction hash"
    - "memoHash and railgunTxRef stored for Phase 6 on-chain recording"
  artifacts:
    - path: "frontend/src/lib/railgun-clean/payments.js"
      provides: "paySellerV2 delegates to privateTransfer"
      contains: "import.*privateTransfer"
    - path: "frontend/src/components/railgun/PrivatePaymentModal.jsx"
      provides: "UI progress during proof generation"
      contains: "onProgress|Generating.*proof"
  key_links:
    - from: "frontend/src/lib/railgun-clean/payments.js"
      to: "frontend/src/lib/railgun-clean/operations/transfer.js"
      via: "import { privateTransfer }"
      pattern: "privateTransfer\\("
    - from: "frontend/src/components/railgun/PrivatePaymentModal.jsx"
      to: "frontend/src/lib/railgun-clean/index.js"
      via: "import { privateTransfer }"
      pattern: "onProgress.*step.*proving"
---

<objective>
Wire up UI to use the new privateTransfer function with progress feedback.

Purpose: User can see proof generation progress (20-30 seconds) and complete private payments
Output: Working private payment flow with progress UI and stored transaction references
</objective>

<execution_context>
@~/.claude/get-shit-done/workflows/execute-plan.md
@~/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/05-private-transfer/05-RESEARCH.md
@.planning/phases/05-private-transfer/05-01-SUMMARY.md
@frontend/src/lib/railgun-clean/payments.js
@frontend/src/components/railgun/PrivatePaymentModal.jsx
</context>

<tasks>

<task type="auto">
  <name>Task 1: Update payments.js to use new privateTransfer</name>
  <files>frontend/src/lib/railgun-clean/payments.js</files>
  <action>
Refactor `paySellerV2` to delegate to the new `privateTransfer` from operations/transfer.js.

1. Replace the dynamic import with static import:
```javascript
import { privateTransfer } from './operations/transfer';
```

2. Simplify `paySellerV2` to delegate:
```javascript
export async function paySellerV2(params = {}) {
  const { sellerRailgunAddress, amountWei, tokenAddress, productId, onProgress } = params;

  try {
    onProgress?.({ step: 'prepare', message: 'Preparing private transaction...' });

    const result = await privateTransfer({
      toRailgunAddress: sellerRailgunAddress,
      amountWei,
      tokenAddress,
      productId,
      onProgress
    });

    if (!result.success) {
      throw new Error(result.error || 'Transfer failed');
    }

    // Store memoHash and railgunTxRef for Phase 6 on-chain recording
    // (Component will read these from result)

    onProgress?.({ step: 'complete', message: 'Payment completed successfully!' });

    return {
      success: true,
      txHash: result.txHash,
      memoHash: result.memoHash,
      railgunTxRef: result.railgunTxRef
    };

  } catch (err) {
    console.error('Payment failed:', err);
    onProgress?.({ step: 'error', message: String(err.message || err) });
    return { success: false, error: String(err.message || err) };
  }
}
```

3. Remove the dynamic import of railgun-client-browser.js and the old SDK call pattern

4. Keep `checkWalletState` function unchanged (it's backend fallback)
  </action>
  <verify>grep -n "privateTransfer" frontend/src/lib/railgun-clean/payments.js | grep -q "operations/transfer" && echo "Import added correctly"</verify>
  <done>payments.js updated to delegate to new privateTransfer function</done>
</task>

<task type="auto">
  <name>Task 2: Update handlePrivatePayment in PrivatePaymentModal</name>
  <files>frontend/src/components/railgun/PrivatePaymentModal.jsx</files>
  <action>
**IMPORTANT:** This task UPDATES the existing `handlePrivatePayment` function (lines 893-996).
Do NOT replace the entire function - preserve existing logic and augment with progress UI.

**Patterns to PRESERVE:**
- Balance checking via `getAllBalances()` (lines 918-936)
- Seller address lookup via `getSellerRailgunAddress()` (lines 938-946)
- Wallet state verification via `checkWalletState()` (lines 957-963)
- Error handling with toast notifications
- Storage of pending payment data in localStorage

**Changes to ADD to existing handlePrivatePayment:**

1. Add state for transfer progress (near other useState hooks at top of component):
```javascript
const [transferProgress, setTransferProgress] = useState({ step: 'idle', message: '', progress: 0 });
```

2. Update the paySellerV2 call (around line 966) to include onProgress callback:
```javascript
// BEFORE (existing):
const { hash } = await paySellerV2({
  walletID,
  tokenAddress,
  amount,
  sellerRailgunAddress,
  useBroadcaster: true,
});

// AFTER (updated):
const result = await paySellerV2({
  sellerRailgunAddress: sellerRailgunAddress,
  amountWei: amount.toString(),
  tokenAddress: tokenAddress,
  productId: product.id,
  onProgress: (state) => {
    setTransferProgress(state);
  }
});

// Handle result
if (!result.success) {
  throw new Error(result.error || 'Transfer failed');
}
const hash = result.txHash;
```

3. Update localStorage storage (around line 977) to include memoHash and railgunTxRef:
```javascript
const pendingPaymentData = {
  productId: product.id || '1',
  txHash: hash,
  memoHash: result.memoHash,      // NEW - for Phase 6 on-chain recording
  railgunTxRef: result.railgunTxRef, // NEW - for Phase 6 on-chain recording
  timestamp: Date.now(),
  productAddress: product.address || product.contractAddress
};
```

**UI changes in the payment step (find payment button, around line 1437):**

1. Replace simple spinner with progress indicator during proof generation:
```jsx
{paymentLoading && transferProgress.step === 'proving' ? (
  <div className="flex flex-col items-center space-y-2">
    <div className="animate-spin rounded-full h-6 w-6 border-b-2 border-white"></div>
    <span className="text-sm">{transferProgress.message}</span>
    {transferProgress.progress > 0 && (
      <div className="w-full bg-gray-200 rounded-full h-2">
        <div
          className="bg-purple-600 h-2 rounded-full transition-all duration-300"
          style={{ width: `${transferProgress.progress}%` }}
        />
      </div>
    )}
  </div>
) : paymentLoading ? (
  <div className="flex items-center space-x-2">
    <div className="animate-spin rounded-full h-4 w-4 border-b-2 border-white"></div>
    <span>{transferProgress.message || 'Processing Payment...'}</span>
  </div>
) : (
  'Complete Private Payment'
)}
```

2. Add warning text about proof generation time:
```jsx
<p className="text-xs text-yellow-600 mt-2">
  Note: Proof generation takes 20-30 seconds. Please wait.
</p>
```
  </action>
  <verify>grep -n "transferProgress\|onProgress" frontend/src/components/railgun/PrivatePaymentModal.jsx | head -5 && echo "Progress state added"</verify>
  <done>PrivatePaymentModal updated with progress UI during proof generation, preserving existing flow</done>
</task>

<task type="checkpoint:human-verify" gate="blocking">
  <what-built>Private transfer with progress UI and stored transaction references</what-built>
  <how-to-verify>
1. Start the frontend: `cd frontend && npm start`
2. Connect MetaMask to Sepolia
3. Connect Railgun wallet (use existing connection)
4. Ensure you have shielded WETH balance (from Phase 4)
5. Navigate to marketplace and select a product
6. Click "Private Payment" button
7. Observe:
   - Progress shows "Preparing..."
   - Progress shows "Generating ZK proof..." with percentage
   - Progress bar fills during 20-30 second proof generation
   - On success: toast with transaction hash
8. Check browser console for:
   - `[Transfer]` log entries
   - memoHash and railgunTxRef in console output
9. Check localStorage for stored payment data:
   - Open DevTools > Application > Local Storage
   - Look for `pending_private_payment_*` key
   - Verify it contains memoHash and railgunTxRef

**POI (Proof of Innocence) Note:**
The Railgun SDK automatically handles POI verification during proof generation.
When `generateTransferProof` runs, the SDK verifies that:
- All input UTXOs have valid POI status
- The transaction meets the POI requirements for the network

No explicit POI check is needed in our code - if POI verification fails,
`generateTransferProof` will throw an error that gets caught and displayed.
During verification, watch for any POI-related errors in the console.
  </how-to-verify>
  <resume-signal>Type "approved" if payment completes with progress UI, or describe issues</resume-signal>
</task>

</tasks>

<verification>
1. payments.js imports and uses privateTransfer from operations/transfer.js
2. PrivatePaymentModal shows progress during proof generation
3. Existing handlePrivatePayment logic (balance check, seller lookup, wallet state) preserved
4. memoHash and railgunTxRef stored in localStorage for Phase 6
5. Human verifies end-to-end private transfer works on Sepolia
6. POI verification handled automatically by SDK (errors surfaced if POI fails)
</verification>

<success_criteria>
- [ ] payments.js delegates to privateTransfer
- [ ] PrivatePaymentModal has transferProgress state
- [ ] Existing balance/wallet checks preserved
- [ ] Progress bar shows during proof generation
- [ ] Warning text about 20-30 second wait
- [ ] Toast shows transaction hash on success
- [ ] localStorage stores memoHash and railgunTxRef
- [ ] Human verification passes
</success_criteria>

<output>
After completion, create `.planning/phases/05-private-transfer/05-02-SUMMARY.md`
</output>
